#rq_processing.R

#LAST UPDATED 2/17/2020

#This script mainly uses the rq.merged dataset, which contains respirometry data 
#and body composition data for each (minute) of every run. 
#This script annotates every minute of data with the metabolism state at that time.
#This script calculates several key energetic variables.
#This script uses the period.cutoffs dataset, generated by the script bodymass.R
#to add seasonal period annotations to the main dataset for every minute of every run
#This script generates and saves the rq.final dataset, which will be used in the analysis.R script.
#This script generates and saves an example plot for Fig. S8.

################################################################################
################################################################################

#set working directory
#setwd("~/ERICH_EBERTS/ACADEMICS/PROJECTS/FAT/FAT_DATA/FAT_CODE/FINAL_DATA")

################################################################################

#load in libraries
library(readxl)
library(ggplot2)
library(ggpubr)
library(tidyr)
library(dplyr)
library(plotrix)
library(gridExtra)
library(changepoint)
library(changepoint.np)
library(MESS)
library(nlme) 
library(effects)
library(here) # Anusha added

################################################################################

#set my theme for any ggplot graphs i output.
my_theme <- theme_classic(base_size = 20) +
  theme(panel.border = element_rect(colour = "black", fill=NA)) +
  theme(axis.text.x = element_text(angle=0, size=16), legend.key.height = unit(3, 'lines'),
        panel.grid.major.y = element_line(color='white'),
        panel.grid.minor.y = element_line(color='white'))+
  theme(axis.text.y = element_text(angle=0, size=20), legend.key.height = unit(3, 'lines'),
        panel.grid.major.x = element_line(color='white'), 
        panel.grid.minor.x = element_line(color='white'))+
  theme(plot.caption = element_text(size = 20, hjust = 0.5))

################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################

## Using Rproj and here() to read file in
#LOAD RESPIROMETRY AND BODYCOMP DATA
rq.merged <- read.csv(here("Erich_torporstateData", "rq_merged.csv"))


#rq.merged<-read.csv("rq_merged.csv")
#rq.merged

################################################################################

#LOAD SEASONAL CUTOFF DATAFRAME, GENERATED BY BODY MASS FINAL CODE
period.cutoffs<-read.csv(here("Erich_torporstateData", "season_cutoffs.csv"))
period.cutoffs$Bird_ID<-as.character(period.cutoffs$Bird_ID) #CORRECT STRUCTURE OF BIRD ID. 

################################################################################
#END DATA SETUP
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################

#FUNCTION FOR LABELING METABOLIC STATES FOR NORMOTHERMIC NIGHTS
RUN_ID<-rq.merged[rq.merged$Run_ID=="B7_9.11.19",]
NORMO_smooth_state_func<-function(RUN_ID){
    #Create blank vectors that will be filled for torpor nights. 
    RUN_ID$Torpor_Type<-"NORMO"
    RUN_ID$VO2_int<-NA
    RUN_ID$VO2_smooth<-NA
    RUN_ID$VO2_smoothderiv<-NA
    RUN_ID$Stability<-NA
    RUN_ID$State<-"NORMO"
    RUN_ID$Freak_Start<-NA
    RUN_ID$Freak_End<-NA
    RUN_ID$Normopre_Start<-NA
    RUN_ID$Normopre_End<-NA
    RUN_ID$Entry_Start<-NA
    RUN_ID$Entry_End<-NA
    RUN_ID$Torpor_Start<-NA
    RUN_ID$Torpor_End<-NA
    RUN_ID$Arousal_Start<-NA
    RUN_ID$Arousal_End<-NA
    RUN_ID$Normopost_Start<-NA
    RUN_ID$Normopost_End<-NA
    RUN_ID$Pre_Duration<-NA
    RUN_ID$Entry_Duration<-NA
    RUN_ID$Torpor_Duration<-NA
    RUN_ID$Arousal_Duration<-NA
    RUN_ID$Post_Duration<-NA
    RUN_ID$Night_Duration<-RUN_ID$MinElapsed_LON
    #RUN_ID$Time_p<-NA
    RUN_ID$Time_p<- RUN_ID$Minute_Elapsed/RUN_ID$Night_Duration*100
    RUN_ID$Time_p_Entry_Start<-NA
    RUN_ID$Time_p_Entry_End<-NA
    RUN_ID$Time_p_Torpor_Start<-NA
    RUN_ID$Time_p_Torpor_End<-NA
    RUN_ID$Time_p_Arousal_Start<-NA
    RUN_ID$Time_p_Arousal_End<-NA
    RUN_ID$Pre_Percent_Night<-NA
    RUN_ID$Entry_Percent_Night <-NA
    RUN_ID$Torpor_Percent_Night <-NA
    RUN_ID$Arousal_Percent_Night<-NA
    RUN_ID$Post_Percent_Night<-NA

    #plot the normothermic nights
    plot<-ggplot(data=RUN_ID)+
      geom_rect(alpha=.002,col="red",fill="red",xmin=0,xmax=800,ymin=-1, ymax=2)+
      geom_point(aes(x=Minute_Elapsed, y=VO2), col="black",lwd=2)+
      geom_line(aes(x=Minute_Elapsed, y=VO2), col="black",lwd=.5)+
      geom_smooth(method="loess",aes(x=Minute_Elapsed, y=VO2, col=State), lwd=1, alpha=.2,se=F)+
      scale_y_continuous(limits = c(0,1.5))+
      my_theme  #+ theme(legend.position = "none")
    print(plot)
    
return(RUN_ID)
} #END NORMO STATE FUNCTION

################################################################################
################################################################################

#SET UP RQ.STATE TO BE FILLED IN WHEN THE STATE FUNCTION IS RUN FOR EACH NIGHT. 
#THIS SETS UP BOTH THE NORMOTHERMIC STATE FUNCTION AND THE TORPID STATE FUNCTIONS.

rq.state<-rq.merged

rq.state$Torpor_Type<-NA
rq.state$VO2_int<-NA
rq.state$VO2_smooth<-NA
rq.state$VO2_smoothderiv<-NA
rq.state$Stability<-NA
rq.state$State<-NA
rq.state$Freak_Start<-NA
rq.state$Freak_End<-NA
rq.state$Normopre_Start<-NA
rq.state$Normopre_End<-NA
rq.state$Entry_Start<-NA
rq.state$Entry_End<-NA
rq.state$Torpor_Start<-NA
rq.state$Torpor_End<-NA
rq.state$Arousal_Start<-NA
rq.state$Arousal_End<-NA
rq.state$Normopost_Start<-NA
rq.state$Normopost_End<-NA
rq.state$Pre_Duration<-NA
rq.state$Entry_Duration<-NA
rq.state$Torpor_Duration<-NA
rq.state$Arousal_Duration<-NA
rq.state$Post_Duration<-NA
rq.state$Night_Duration<-NA
rq.state$Time_p<-NA
rq.state$Time_p_Entry_Start<-NA
rq.state$Time_p_Entry_End<-NA
rq.state$Time_p_Torpor_Start<-NA
rq.state$Time_p_Torpor_End<-NA
rq.state$Time_p_Arousal_Start<-NA
rq.state$Time_p_Arousal_End<-NA
rq.state$Pre_Percent_Night<-NA
rq.state$Entry_Percent_Night <-NA
rq.state$Torpor_Percent_Night <-NA
rq.state$Arousal_Percent_Night<-NA
rq.state$Post_Percent_Night<-NA

################################################################################
################################################################################

#RUN THE NORMO STATE FUNCTION FOR EACH NOORMOTHERMIC NIGHT

for(i in 1:nrow(rq.merged)) {
  
}
rq.state[rq.state$Run_ID=="B3_7.19.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B3_7.19.18",])
rq.state[rq.state$Run_ID=="B1_7.22.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B1_7.22.18",])
rq.state[rq.state$Run_ID=="B2_7.22.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B2_7.22.18",])
rq.state[rq.state$Run_ID=="B1_7.26.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B1_7.26.18",])
rq.state[rq.state$Run_ID=="B3_7.26.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B3_7.26.18",])
rq.state[rq.state$Run_ID=="B4_8.6.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B4_8.6.18",])
rq.state[rq.state$Run_ID=="B1_8.8.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B1_8.8.18",])
rq.state[rq.state$Run_ID=="B3_8.8.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B3_8.8.18",])
rq.state[rq.state$Run_ID=="B4_8.13.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B4_8.13.18",])
rq.state[rq.state$Run_ID=="B1_8.15.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B1_8.15.18",])
rq.state[rq.state$Run_ID=="B2_8.20.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B2_8.20.18",])
rq.state[rq.state$Run_ID=="B4_8.20.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B4_8.20.18",])
rq.state[rq.state$Run_ID=="B1_8.22.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B1_8.22.18",])
rq.state[rq.state$Run_ID=="B3_8.24.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B3_8.24.18",])
rq.state[rq.state$Run_ID=="B4_8.26.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B4_8.26.18",])
rq.state[rq.state$Run_ID=="B1_8.27.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B1_8.27.18",])#THIS NIGHT GETS TAKEN OUT 
rq.state[rq.state$Run_ID=="B5_8.27.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B5_8.27.18",])#THIS NIGHT GETS TAKEN OUT 
rq.state[rq.state$Run_ID=="B3_8.29.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B3_8.29.18",])
rq.state[rq.state$Run_ID=="B4_8.29.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B4_8.29.18",])
rq.state[rq.state$Run_ID=="B1_8.31.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B1_8.31.18",])
rq.state[rq.state$Run_ID=="B2_8.31.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B2_8.31.18",])
rq.state[rq.state$Run_ID=="B3_9.2.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B3_9.2.18",])
rq.state[rq.state$Run_ID=="B4_9.6.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B4_9.6.18",])
rq.state[rq.state$Run_ID=="B5_9.6.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B5_9.6.18",])
rq.state[rq.state$Run_ID=="B4_9.8.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B4_9.8.18",])#THIS NIGHT GETS TAKEN OUT
rq.state[rq.state$Run_ID=="B1_9.9.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B1_9.9.18",])
rq.state[rq.state$Run_ID=="B2_9.9.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B2_9.9.18",])
rq.state[rq.state$Run_ID=="B3_9.10.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B3_9.10.18",])
rq.state[rq.state$Run_ID=="B5_9.10.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B5_9.10.18",])
rq.state[rq.state$Run_ID=="B1_9.12.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B1_9.12.18",])
rq.state[rq.state$Run_ID=="B4_9.12.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B4_9.12.18",])
rq.state[rq.state$Run_ID=="B2_9.15.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B2_9.15.18",])
rq.state[rq.state$Run_ID=="B5_9.15.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B5_9.15.18",])
rq.state[rq.state$Run_ID=="B3_9.17.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B3_9.17.18",])
rq.state[rq.state$Run_ID=="B5_9.17.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B5_9.17.18",])
rq.state[rq.state$Run_ID=="B4_9.19.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B4_9.19.18",])
rq.state[rq.state$Run_ID=="B5_9.19.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B5_9.19.18",])
rq.state[rq.state$Run_ID=="B1_9.20.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B1_9.20.18",])
rq.state[rq.state$Run_ID=="B4_9.25.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B4_9.25.18",])#THIS NIGHT GETS TAKEN OUT
rq.state[rq.state$Run_ID=="B5_9.25.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B5_9.25.18",])#THIS NIGHT GETS TAKEN OUT
rq.state[rq.state$Run_ID=="B1_9.26.18",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B1_9.26.18",])
rq.state[rq.state$Run_ID=="B6_6.24.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B6_6.24.19",])
rq.state[rq.state$Run_ID=="B7_6.24.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B7_6.24.19",])
rq.state[rq.state$Run_ID=="B8_6.24.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B8_6.24.19",])
rq.state[rq.state$Run_ID=="B6_6.26.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B6_6.26.19",])
rq.state[rq.state$Run_ID=="B7_6.26.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B7_6.26.19",])
rq.state[rq.state$Run_ID=="B8_6.27.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B8_6.27.19",])
rq.state[rq.state$Run_ID=="B9_6.27.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B9_6.27.19",])
rq.state[rq.state$Run_ID=="B6_7.1.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B6_7.1.19",])
rq.state[rq.state$Run_ID=="B8_7.1.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B8_7.1.19",])
rq.state[rq.state$Run_ID=="B9_7.3.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B9_7.3.19",])
rq.state[rq.state$Run_ID=="B10_7.3.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B10_7.3.19",])
rq.state[rq.state$Run_ID=="B12_7.3.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B12_7.3.19",])
rq.state[rq.state$Run_ID=="B6_7.4.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B6_7.4.19",])
rq.state[rq.state$Run_ID=="B7_7.4.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B7_7.4.19",])
rq.state[rq.state$Run_ID=="B8_7.4.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B8_7.4.19",])
rq.state[rq.state$Run_ID=="B11_7.8.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B11_7.8.19",])
rq.state[rq.state$Run_ID=="B13_7.8.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B13_7.8.19",])
rq.state[rq.state$Run_ID=="B14_7.8.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B14_7.8.19",])
rq.state[rq.state$Run_ID=="B12_7.11.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B12_7.11.19",])
rq.state[rq.state$Run_ID=="B13_7.11.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B13_7.11.19",])
rq.state[rq.state$Run_ID=="B16_7.11.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B16_7.11.19",])
rq.state[rq.state$Run_ID=="B9_7.12.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B9_7.12.19",])
rq.state[rq.state$Run_ID=="B14_7.12.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B14_7.12.19",])
rq.state[rq.state$Run_ID=="B15_7.12.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B15_7.12.19",])
rq.state[rq.state$Run_ID=="B6_7.16.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B6_7.16.19",])
rq.state[rq.state$Run_ID=="B7_7.16.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B7_7.16.19",])#BAD RUN gets taken out 
rq.state[rq.state$Run_ID=="B8_7.16.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B8_7.16.19",])
rq.state[rq.state$Run_ID=="B10_7.17.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B10_7.17.19",])
rq.state[rq.state$Run_ID=="B11_7.17.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B11_7.17.19",])
rq.state[rq.state$Run_ID=="B16_7.17.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B16_7.17.19",])
rq.state[rq.state$Run_ID=="B6_7.22.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B6_7.22.19",])
rq.state[rq.state$Run_ID=="B7_7.22.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B7_7.22.19",])
rq.state[rq.state$Run_ID=="B9_7.30.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B9_7.30.19",])
rq.state[rq.state$Run_ID=="B15_7.30.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B15_7.30.19",])
rq.state[rq.state$Run_ID=="B17_7.30.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B17_7.30.19",])
rq.state[rq.state$Run_ID=="B9_8.11.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B9_8.11.19",])
rq.state[rq.state$Run_ID=="B6_8.13.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B6_8.13.19",])
rq.state[rq.state$Run_ID=="B8_8.13.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B8_8.13.19",])
rq.state[rq.state$Run_ID=="B17_8.13.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B17_8.13.19",])
rq.state[rq.state$Run_ID=="B22_8.14.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B22_8.14.19",])
rq.state[rq.state$Run_ID=="B7_8.20.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B7_8.20.19",])
rq.state[rq.state$Run_ID=="B10_8.20.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B10_8.20.19",])
rq.state[rq.state$Run_ID=="B9_8.21.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B9_8.21.19",])
rq.state[rq.state$Run_ID=="B12_8.21.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B12_8.21.19",])
rq.state[rq.state$Run_ID=="B14_8.21.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B14_8.21.19",])
rq.state[rq.state$Run_ID=="B8_8.23.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B8_8.23.19",])
rq.state[rq.state$Run_ID=="B14_8.23.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B14_8.23.19",])
rq.state[rq.state$Run_ID=="B15_8.23.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B15_8.23.19",])
rq.state[rq.state$Run_ID=="B6_8.26.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B6_8.26.19",])
rq.state[rq.state$Run_ID=="B12_8.26.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B12_8.26.19",])
rq.state[rq.state$Run_ID=="B7_8.31.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B7_8.31.19",])
rq.state[rq.state$Run_ID=="B14_9.1.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B14_9.1.19",])
rq.state[rq.state$Run_ID=="B15_9.2.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B15_9.2.19",])
rq.state[rq.state$Run_ID=="B6_9.3.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B6_9.3.19",])
rq.state[rq.state$Run_ID=="B16_9.3.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B16_9.3.19",])
rq.state[rq.state$Run_ID=="B12_9.6.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B12_9.6.19",])
rq.state[rq.state$Run_ID=="B6_9.7.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B6_9.7.19",])
rq.state[rq.state$Run_ID=="B10_9.10.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B10_9.10.19",])

rq.state[rq.state$Run_ID=="B7_9.11.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B7_9.11.19",])
rq.state$Torpor_Type[rq.state$Run_ID=="B7_9.11.19"]

rq.state[rq.state$Run_ID=="B16_9.17.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B16_9.17.19",])
rq.state[rq.state$Run_ID=="B6_9.18.19",]<-NORMO_smooth_state_func(rq.merged[rq.merged$Run_ID=="B6_9.18.19",])

################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################

#FUNCTION FOR LABELING METABOLIC STATES FOR TORPID NIGHTS

TORPOR_smooth_state_func<-function(RUN_ID, SPAR_SMOOTHINT, ENTRY_CUTOFF,AROUSAL_CUTOFF){
    ############################################################################
    
    #FIRST GENERATE VECTORS OF INTERPOLATED, SMOOTHED VO2 DATA AND ITS SLOPE
  
    #interpolate data linearly
    RUN_ID$VO2_int<-na.approx(RUN_ID$VO2,
                          x=RUN_ID$Minute_Elapsed, na.rm=F)
    #plot(RUN_ID$VO2_int) 

    #generate a spline model to smooth interpolated data
    splinemod.vo2<-smooth.spline(RUN_ID$VO2_int[is.na(RUN_ID$VO2_int)==F],
                          x=RUN_ID$Minute_Elapsed[is.na(RUN_ID$VO2_int)==F],
                            spar=SPAR_SMOOTHINT) 

    #generate smoothed VO2 data for each minute, based on above spline model
    predmodel<- predict(splinemod.vo2, x=seq(0,length(RUN_ID$Minute_Elapsed), length=length(RUN_ID$Minute_Elapsed))) 
    RUN_ID$VO2_smooth<-predmodel$y 
    #plot(RUN_ID$VO2_smooth)
    
    #generate the first derivative (slope) of smoothed VO2 data for each minute, based on above spline model
    predmodel_deriv<-predict(splinemod.vo2, deriv=1, x=seq(0,length(RUN_ID$Minute_Elapsed), length=length(RUN_ID$Minute_Elapsed))) 
    RUN_ID$VO2_smoothderiv<-predmodel_deriv$y
    #plot(RUN_ID$VO2_smoothderiv) 
    
    ############################################################################
    
    #SET ENTRY AND AROUSAL CUTOFFS

    #this is initially determined by trial and error, but it is only really used 
    #to generate some general bounds of the states in order to generate 2 
    #separate splines, one for entry and one for arousal, which is done in state funciton 2
    
    ENTRY_CUTOFF<- -0.003 #(VO2/MIN)
    AROUSAL_CUTOFF<- 0.005 #(VO2/MIN)
    
    ############################################################################
   
    #ANNOTATE EACH MINUTE OF VO2 WITH A STABILITY LABEL BASED ON ITS RATE OF CHANGE
    #AND THE CUTOFF VALUES

    RUN_ID$Stability<-"STABLE" #make everything stable to start
    
    #label everything with a slope of less than -.003 as "DECREASING"
    RUN_ID$Stability[RUN_ID$VO2_smoothderiv < ENTRY_CUTOFF] <- "DECREASING"

    #label everything with a slope of more than .005 as "INCREASING"
    RUN_ID$Stability[RUN_ID$VO2_smoothderiv > AROUSAL_CUTOFF] <-"INCREASING"
    
    #copy the stability labels to state, which will be turned into actual states below
    RUN_ID$State<-RUN_ID$Stability

    ##plot vo2, colored by stability
    #ggplot(data=RUN_ID)+
    #  geom_point(aes(x=Minute_Elapsed, y=VO2), col="black",lwd=2)+
    #  geom_point(aes(x=Minute_Elapsed, y=VO2_smooth, col=Stability),lwd=2 ,alpha=.9)+
    ##  geom_point(aes(x=Minute_Elapsed, y=VO2_smoothderiv*2, col=Stability))+
    # my_theme  #+ theme(legend.position = "none")

    ############################################################################
     
    #ANNOTATE EACH MINUTE OF VO2 WITH A STATE LABEL BASED ON THE STABILITY AND THE LOGICAL ORDER OF TORPOR
    
    ############################################################################
    
    #Within the torpor nights, there are a few different patterns based on 
    #time resolution and data completeness. #these require slightly different
    #criteria/logic to label properly
    #1. Full nights where there is a full normal pattern 
    #2. NoPre nights with no or minimal pretorpor values (when the bird starts torpor pretty much immediately) 
    #3. NoPost night with no or minimal post torpor values
    #4. Dip nights when the bird never reaches stable torpor
    #5. Double torpor nights. #THESE CURRENTLY DONT WORK so it is commented out AND ARE TAKEN OUT IN LATER ANALYSES. 
    
    #THE FOLLOWING ARE  IF/ELSEIF STATEMENTS DEPENDING OF WHAT TORPOR_TYPE

    ############################################################################

    #FULL TORPOR 
    if(RUN_ID$Torpor_Type[1]=="Full"){

        #where vo2 INCREASING and min elapsed is AFTER the 1st stable period, label as AROUSAL
        RUN_ID$State[RUN_ID$Stability=="INCREASING" &
                      RUN_ID$Minute_Elapsed >= first(RUN_ID$Minute_Elapsed[RUN_ID$Stability=="STABLE"])]<-"AROUSAL"
          
        #where VO2 STABLE, and min elapsed is before the start of entry, as "NORMOPRE"
        RUN_ID$State[RUN_ID$Stability== "STABLE" & 
                      RUN_ID$Minute_Elapsed <= last(RUN_ID$Minute_Elapsed[RUN_ID$Stability=="DECREASING"])] <- "NORMOPRE" 
          
        #where VO2 stable, and min elapsed is before the start of AROUSAL, as "NORMOPOST"
        RUN_ID$State[RUN_ID$Stability== "STABLE" &
                       RUN_ID$Minute_Elapsed >= last(RUN_ID$Minute_Elapsed[RUN_ID$Stability=="INCREASING"])] <- "NORMOPOST" 
         
          #where VO2 is DECREASING, and min elapsed is BEFORE THE START OF NORMOPRE , as "FREAKOUT"
        RUN_ID$State[RUN_ID$State== "DECREASING" & 
                      RUN_ID$Minute_Elapsed <= first(RUN_ID$Minute_Elapsed[RUN_ID$State=="NORMOPRE"])] <- "FREAKOUT" 
          
        #where VO2 is DECREASING, and min elapsed is AFTER the start of entry, as "ENTRY"
        RUN_ID$State[RUN_ID$State== "DECREASING" & 
                       RUN_ID$Minute_Elapsed >= last(RUN_ID$Minute_Elapsed[RUN_ID$State=="NORMOPRE"])] <- "ENTRY" 
          
        #where VO2 stable, and min elapsed is AFTER the end of entry, and BEFORE the start of arousal, as TORPOR
        RUN_ID$State[RUN_ID$Minute_Elapsed <= (first(RUN_ID$Minute_Elapsed[RUN_ID$State=="AROUSAL"])) &
                       RUN_ID$Minute_Elapsed >= (last(RUN_ID$Minute_Elapsed[RUN_ID$State=="ENTRY"]))] <- "TORPOR" 
    }#END FULL TORPOR

    ############################################################################

    #DIP 
    else if(RUN_ID$Torpor_Type[1]=="Dip"){ 

        #where vo2 INCREASING and min elapsed is AFTER the 1st stable period, label as AROUSAL
        RUN_ID$State[RUN_ID$Stability=="INCREASING" &
                      RUN_ID$Minute_Elapsed >= first(RUN_ID$Minute_Elapsed[RUN_ID$Stability=="STABLE"])]<-"AROUSAL"
          
        #where VO2 STABLE, and min elapsed is before the start of entry, as "NORMOPRE"
        RUN_ID$State[RUN_ID$Stability== "STABLE" & 
                      RUN_ID$Minute_Elapsed <= last(RUN_ID$Minute_Elapsed[RUN_ID$Stability=="DECREASING"])] <- "NORMOPRE" 
          
        #where VO2 stable, and min elapsed is before the start of AROUSAL, as "NORMOPOST"
        RUN_ID$State[RUN_ID$Stability== "STABLE" &
                      RUN_ID$Minute_Elapsed >= last(RUN_ID$Minute_Elapsed[RUN_ID$Stability=="INCREASING"])] <- "NORMOPOST" 
          
        #where VO2 is DECREASING, and min elapsed is BEFORE THE START OF NORMOPRE , as "FREAKOUT"
        RUN_ID$State[RUN_ID$State== "DECREASING" & 
                      RUN_ID$Minute_Elapsed <= first(RUN_ID$Minute_Elapsed[RUN_ID$State=="NORMOPRE"])] <- "FREAKOUT" 
          
        #where VO2 is DECREASING, and min elapsed is AFTER the start of entry, as "ENTRY"
        RUN_ID$State[RUN_ID$State== "DECREASING" & 
                      RUN_ID$Minute_Elapsed >= last(RUN_ID$Minute_Elapsed[RUN_ID$State=="NORMOPRE"])] <- "ENTRY" 
        
        #where VO2 stable, and min elapsed is AFTER the end of entry, and BEFORE the start of arousal, as TORPOR
        RUN_ID$State[RUN_ID$Minute_Elapsed <= (first(RUN_ID$Minute_Elapsed[RUN_ID$State=="AROUSAL"])) &
                       RUN_ID$Minute_Elapsed >= (last(RUN_ID$Minute_Elapsed[RUN_ID$State=="ENTRY"]))] <- "TORPOR" 
          
    }#END DIP

    ############################################################################

    #NOPOST
    else if(RUN_ID$Torpor_Type[1]=="NoPost"){

        #where vo2 INCREASING and min elapsed is AFTER the 1st stable period, label as AROUSAL
        RUN_ID$State[RUN_ID$Stability=="INCREASING" &
                      RUN_ID$Minute_Elapsed >= first(RUN_ID$Minute_Elapsed[RUN_ID$Stability=="STABLE"])]<-"AROUSAL"
          
        #where VO2 STABLE, and min elapsed is before the start of entry, as "NORMOPRE"
        RUN_ID$State[RUN_ID$Stability== "STABLE" & 
                      RUN_ID$Minute_Elapsed <= last(RUN_ID$Minute_Elapsed[RUN_ID$Stability=="DECREASING"])] <- "NORMOPRE" 
          
        #where VO2 stable, and min elapsed is before the start of AROUSAL, as "NORMOPOST"
        # RUN_ID$State[RUN_ID$Stability== "STABLE" &
        #                RUN_ID$Minute_Elapsed >= last(RUN_ID$Minute_Elapsed[RUN_ID$Stability=="INCREASING"])] <- "NORMOPOST" 
        RUN_ID$State[RUN_ID$Minute_Elapsed>length(RUN_ID$Minute_Elapsed)-2] <- "NORMOPOST" 
        RUN_ID$State[RUN_ID$Minute_Elapsed>length(RUN_ID$Minute_Elapsed)-3] <- "NORMOPOST" 

        #where VO2 is DECREASING, and min elapsed is BEFORE THE START OF NORMOPRE , as "FREAKOUT"
        RUN_ID$State[RUN_ID$State== "DECREASING" & 
                     RUN_ID$Minute_Elapsed <= first(RUN_ID$Minute_Elapsed[RUN_ID$State=="NORMOPRE"])] <- "FREAKOUT" 
          
        #where VO2 is DECREASING, and min elapsed is AFTER the start of entry, as "ENTRY"
        RUN_ID$State[RUN_ID$State== "DECREASING" & 
                       RUN_ID$Minute_Elapsed >= last(RUN_ID$Minute_Elapsed[RUN_ID$State=="NORMOPRE"])] <- "ENTRY" 
          
        #where VO2 stable, and min elapsed is AFTER the end of entry, and BEFORE the start of arousal, as TORPOR
        RUN_ID$State[RUN_ID$Minute_Elapsed <= (first(RUN_ID$Minute_Elapsed[RUN_ID$State=="AROUSAL"])) &
                       RUN_ID$Minute_Elapsed >= (last(RUN_ID$Minute_Elapsed[RUN_ID$State=="ENTRY"]))] <- "TORPOR" 
      
    }#END NOPOST
              
    ############################################################################

    #NO PRE TORPOR NORMOTHERMY
    else if(RUN_ID$Torpor_Type[1]=="NoPre"){ 
        
      #where vo2 INCREASING and min elapsed is AFTER the 1st stable period, label as AROUSAL
      RUN_ID$State[RUN_ID$Stability=="INCREASING" &
                    RUN_ID$Minute_Elapsed >= first(RUN_ID$Minute_Elapsed[RUN_ID$Stability=="STABLE"])]<-"AROUSAL"
          
      #since htere is no stable period in nopres, just mark the first row (really the 0 row) as NORMOPRE
      RUN_ID$State[RUN_ID$Minute_Elapsed<1] <- "NORMOPRE" 
        
      #Since There is no stable period in nopres, just mark the first row (really the 0 row) as NORMOPRE
      RUN_ID$State[RUN_ID$Minute_Elapsed<1] <- "NORMOPRE" 

      #where VO2 stable, and min elapsed is before the start of AROUSAL, as "NORMOPOST"
      RUN_ID$State[RUN_ID$Minute_Elapsed>length(RUN_ID$Minute_Elapsed)-2] <- "NORMOPOST" 
          
      ##theres not going to be freakouts in these nopre nights
      #where VO2 is DECREASING, and min elapsed is BEFORE THE START OF NORMOPRE , as "FREAKOUT"
      #RUN_ID$State[RUN_ID$State== "DECREASING" & 
      #               RUN_ID$Minute_Elapsed <= first(RUN_ID$Minute_Elapsed[RUN_ID$State=="NORMOPRE"])] <- "FREAKOUT" 
          
      #where VO2 is DECREASING, and min elapsed is AFTER the start of entry, as "ENTRY"
      RUN_ID$State[RUN_ID$State== "DECREASING" & 
                     RUN_ID$Minute_Elapsed >= last(RUN_ID$Minute_Elapsed[RUN_ID$State=="NORMOPRE"])] <- "ENTRY" 
          
      #where VO2 stable, and min elapsed is AFTER the end of entry, and BEFORE the start of arousal, as TORPOR
      RUN_ID$State[RUN_ID$Minute_Elapsed <= (first(RUN_ID$Minute_Elapsed[RUN_ID$State=="AROUSAL"])) &
                       RUN_ID$Minute_Elapsed >= (last(RUN_ID$Minute_Elapsed[RUN_ID$State=="ENTRY"]))] <- "TORPOR" 
      
      #where VO2 STABLE, and min elapsed is before the start of entry, as "NORMOPRE"
      RUN_ID$State[RUN_ID$Stability== "STABLE" & 
                    RUN_ID$Minute_Elapsed <= first(RUN_ID$Minute_Elapsed[RUN_ID$State=="ENTRY"])] <- "NORMOPRE" 
          
          
    } 
  
    #This one night is really messed up and work work without manually filling in 
    #the labels, which are really obvious. this is only needed for this preliminary
    #state function so it is really no different from any other night. 
  
    if(RUN_ID$Run_ID[1]=="B12_9.5.19"){
          RUN_ID$State[RUN_ID$State=="STABLE" & RUN_ID$Minute_Elapsed<600]<-"TORPOR"
          RUN_ID$State[RUN_ID$State=="STABLE" & RUN_ID$Minute_Elapsed>=600&RUN_ID$State!="NORMOPOST" ]<-"AROUSAL"
    }
    
    ##############################################################################     
    ##############################################################################    
    
    #RESTRUCTURE STATE AS A FACTOR
    #the above functions mess some structures up so this corrects. 
    
    RUN_ID$State<-factor(RUN_ID$State, levels=c("FREAKOUT","NORMOPRE","ENTRY","TORPOR","AROUSAL", "NORMOPOST"),ordered=F)
    RUN_ID$State<-as.character(RUN_ID$State)
  
    ##############################################################################
    
    #CALCULATE SEVERAL SPECIFIC VALUES FOR EACH NIGHT AND SAVE THEM TO RUN_ID
  
    #Create vectors of single values for the boundaries of each state period
    RUN_ID$Freak_Start<-min(RUN_ID$Minute_Elapsed[RUN_ID$State=="FREAKOUT"],na.rm=T)
    RUN_ID$Freak_End<-max(RUN_ID$Minute_Elapsed[RUN_ID$State=="FREAKOUT"],na.rm=T)
    RUN_ID$Normopre_Start<-min(RUN_ID$Minute_Elapsed[RUN_ID$State=="NORMOPRE"],na.rm=T)
    RUN_ID$Normopre_End<-max(RUN_ID$Minute_Elapsed[RUN_ID$State=="NORMOPRE"],na.rm=T)
    RUN_ID$Entry_Start<-min(RUN_ID$Minute_Elapsed[RUN_ID$State=="ENTRY"],na.rm=T)
    RUN_ID$Entry_End<-max(RUN_ID$Minute_Elapsed[RUN_ID$State=="ENTRY"],na.rm=T)
    RUN_ID$Torpor_Start<-min(RUN_ID$Minute_Elapsed[RUN_ID$State=="TORPOR"],na.rm=T)
    RUN_ID$Torpor_End<-max(RUN_ID$Minute_Elapsed[RUN_ID$State=="TORPOR"],na.rm=T)
    RUN_ID$Arousal_Start<-min(RUN_ID$Minute_Elapsed[RUN_ID$State=="AROUSAL"],na.rm=T)
    RUN_ID$Arousal_End<-max(RUN_ID$Minute_Elapsed[RUN_ID$State=="AROUSAL"],na.rm=T)
    RUN_ID$Normopost_Start<-min(RUN_ID$Minute_Elapsed[RUN_ID$State=="NORMOPOST"],na.rm=T,na.rm=T)
    RUN_ID$Normopost_End<-max(RUN_ID$Minute_Elapsed[RUN_ID$State=="NORMOPOST"],na.rm=T)

    ###########################################################################
    
    #Generate blank vectors that will be filled in state function 2
    #Turn them to NA rather than deleting them so that the orders of the variables wont get messed up

    RUN_ID$Pre_Duration<-NA
    RUN_ID$Entry_Duration<-NA
    RUN_ID$Torpor_Duration<-NA
    RUN_ID$Arousal_Duration<-NA
    RUN_ID$Post_Duration<-NA
    RUN_ID$Night_Duration<-NA

    ###########################################################################
        
    #Calculate a time vector as % of the night duration 
    RUN_ID$Time_p<- NA #RUN_ID$Minute_Elapsed/RUN_ID$Night_Duration*100 #THIS is going to be na for now cuz night duraiton is na. 
  
    ###########################################################################

    #Generate blank vectors that will be filled in state function 2
    #Turn them to NA rather than deleting them so that the orders of the variables wont get messed up
    #RUN_ID$Time_p_LOFF<-RUN_ID$Minute_Elapsed[RUN_ID$Minute_Elapsed==RUN_ID$MinElapsed_LOFF[1]]/RUN_ID$Night_Duration#SHOUDL BE 0%
    RUN_ID$Time_p_Entry_Start<-NA
    RUN_ID$Time_p_Entry_End<-NA
    RUN_ID$Time_p_Torpor_Start<-NA
    RUN_ID$Time_p_Torpor_End<-NA
    RUN_ID$Time_p_Arousal_Start<-NA
    RUN_ID$Time_p_Arousal_End<-NA
    #RUN_ID$Time_p_LON<-RUN_ID$Minute_Elapsed[RUN_ID$Minute_Elapsed==RUN_ID$MinElapsed_LON[1]]/RUN_ID$Night_Duration#SHOUDL BE 100%

    ###########################################################################

    #Generate blank vectors that will be filled in state function 2
    #Turn them to NA rather than deleting them so that the orders of the variables wont get messed up
    RUN_ID$Pre_Percent_Night<- NA
    RUN_ID$Entry_Percent_Night<-NA
    RUN_ID$Torpor_Percent_Night<-NA
    RUN_ID$Arousal_Percent_Night<-NA
    RUN_ID$Post_Percent_Night<-NA
    
  ################################################################################    
  ################################################################################    
  ################################################################################    
  ################################################################################    
  ################################################################################    
  
  #GENERATE A PLOT TO CHECK THAT THE FUNCTION IS WORKING

  plot<-ggplot(data=RUN_ID)+
    
    geom_point(aes(x=Minute_Elapsed, y=VO2), col="black",lwd=2)+
    geom_line(aes(x=Minute_Elapsed,y=VO2_smooth, col=State),lwd=2, alpha=.5)+
    geom_line(aes(x=Minute_Elapsed, y=VO2_int), col="black",lwd=.5)+
    geom_smooth(method="loess",aes(x=Minute_Elapsed, y=VO2_int, col=State), lwd=1, alpha=.2,se=F)+
    scale_color_manual(values=c("green","red","purple","blue","orange", "red"))+
    #scale_y_continuous(limits = c(0,1.5))+
    my_theme  #+ theme(legend.position = "none")
  
  #print(plot)
    
return(RUN_ID)  
}
#END TORPOR STATE FUNCTION

################################################################################
################################################################################

#Set up rq.state to accept new variables generated in the state function
#fix a few nights that are really dips and were labeled as NORMO 
#(these have not been run in the normo-funciton above)
rq.state$Torpor_Use[rq.state$Run_ID=="B2_8.6.18"]<-"TORPOR" 
rq.state$Torpor_Use[rq.state$Run_ID=="B3_9.23.18"]<-"TORPOR" 
rq.state$Torpor_Use[rq.state$Run_ID=="B14_9.6.19"]<-"TORPOR" 

rq.merged$Torpor_Use[rq.merged$Run_ID=="B2_8.6.18"]<-"TORPOR" 
rq.merged$Torpor_Use[rq.merged$Run_ID=="B3_9.23.18"]<-"TORPOR" 
rq.merged$Torpor_Use[rq.merged$Run_ID=="B14_9.6.19"]<-"TORPOR" 

################################################################################

#Label torpid nights with one of the following 'types'
# "Full", "Dip", or "Double", or "NoPre,"NoPost"

rq.merged$Torpor_Type<-"Full"
rq.merged$Torpor_Type[rq.merged$Run_ID=="B2_8.6.18"]<-"Dip"
rq.merged$Torpor_Type[rq.merged$Run_ID=="B5_9.2.18"]<-"Double"
rq.merged$Torpor_Type[rq.merged$Run_ID=="B5_9.8.18"]<-"Double"
rq.merged$Torpor_Type[rq.merged$Run_ID=="B3_9.23.18"]<-"Dip"
rq.merged$Torpor_Type[rq.merged$Run_ID=="B9_6.25.19"]<-"Dip"
rq.merged$Torpor_Type[rq.merged$Run_ID=="B12_6.26.19"]<-"NoPre"
rq.merged$Torpor_Type[rq.merged$Run_ID=="B14_6.29.19"]<-"NoPre"
rq.merged$Torpor_Type[rq.merged$Run_ID=="B15_7.2.19"]<-"Double"
rq.merged$Torpor_Type[rq.merged$Run_ID=="B16_7.7.19"]<-"Double"
rq.merged$Torpor_Type[rq.merged$Run_ID=="B10_7.9.19"]<-"Dip"
rq.merged$Torpor_Type[rq.merged$Run_ID=="B13_7.18.19"]<-"NoPost"
rq.merged$Torpor_Type[rq.merged$Run_ID=="B16_7.21.19"]<-"NoPost"
rq.merged$Torpor_Type[rq.merged$Run_ID=="B11_8.10.19"]<-"NoPost"
rq.merged$Torpor_Type[rq.merged$Run_ID=="B14_8.12.19"]<-"NoPost"
rq.merged$Torpor_Type[rq.merged$Run_ID=="B16_8.12.19"]<-"NoPre"
rq.merged$Torpor_Type[rq.merged$Run_ID=="B9_8.26.19"]<-"Dip"
rq.merged$Torpor_Type[rq.merged$Run_ID=="B13_9.1.19"]<-"Dip"
rq.merged$Torpor_Type[rq.merged$Run_ID=="B12_9.5.19"]<-"NoPost"
rq.merged$Torpor_Type[rq.merged$Run_ID=="B14_9.6.19"]<-"Dip"
rq.merged$Torpor_Type[rq.merged$Run_ID=="B8_9.10.19"]<-"Dip"
rq.merged$Torpor_Type[rq.merged$Run_ID=="B15_9.10.19"]<-"NoPost"
rq.merged$Torpor_Type[rq.merged$Run_ID=="B11_9.16.19"]<-"NoPost"

################################################################################
################################################################################

#RUN THE FIRST TORPOR STATE FUNCTION

################################################################################

#first run the dips

#shallow quick dip- good 
rq.state[rq.state$Run_ID=="B2_8.6.18",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B2_8.6.18",], SPAR_SMOOTHINT=0.5)
#shallow quick dip-gooD
rq.state[rq.state$Run_ID=="B3_9.23.18",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B3_9.23.18",], SPAR_SMOOTHINT=0.65)
#deep dip-good
rq.state[rq.state$Run_ID=="B9_6.25.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B9_6.25.19",], SPAR_SMOOTHINT=0.65) 
#shallow quick dip- good
rq.state[rq.state$Run_ID=="B7_7.10.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B7_7.10.19",], SPAR_SMOOTHINT=0.75)
#deep dip good
rq.state[rq.state$Run_ID=="B9_8.26.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B9_8.26.19",], SPAR_SMOOTHINT=0.65)
#deep dip -good
rq.state[rq.state$Run_ID=="B13_9.1.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B13_9.1.19",], SPAR_SMOOTHINT=0.4)
#shallow dip- good
rq.state[rq.state$Run_ID=="B14_9.6.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B14_9.6.19",], SPAR_SMOOTHINT=0.5)
#deep dip good
rq.state[rq.state$Run_ID=="B8_9.10.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B8_9.10.19",], SPAR_SMOOTHINT=0.65)

################################################################################

#DONT run the doubles cuz they dont work and are weird anyway

# #DOUBLES
# #double torpor-
# rq.state[rq.state$Run_ID=="B5_9.2.18",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B5_9.2.18",], SPAR_SMOOTHINT=.01)
# #double torpor -STILL FUCKED but gets taken out anyway
# rq.state[rq.state$Run_ID=="B5_9.8.18",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B5_9.8.18",], SPAR_SMOOTHINT=0.6)#THIS NIGHT GETS TAKEN OUT
# #no preAND DOUBLE
# rq.state[rq.state$Run_ID=="B15_7.2.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B15_7.2.19",], SPAR_SMOOTHINT=0.65)
# #no pre AND DOUBLE
# rq.state[rq.state$Run_ID=="B16_7.7.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B16_7.7.19",], SPAR_SMOOTHINT=0.65)
# 

################################################################################

#RUN ALL THE OTHER FULL, NOPRE AND NO POST NIGHTS

rq.state[rq.state$Run_ID=="B2_7.19.18",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B2_7.19.18",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B2_7.29.18",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B2_7.29.18",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B4_7.29.18",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B4_7.29.18",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B1_7.30.18",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B1_7.30.18",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B3_7.30.18",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B3_7.30.18",], SPAR_SMOOTHINT=0.7)
rq.state[rq.state$Run_ID=="B2_8.13.18",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B2_8.13.18",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B3_8.15.18",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B3_8.15.18",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B5_8.22.18",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B5_8.22.18",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B5_8.24.18",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B5_8.24.18",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B2_8.26.18",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B2_8.26.18",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B2_9.20.18",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B2_9.20.18",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B2_9.22.18",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B2_9.22.18",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B3_9.22.18",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B3_9.22.18",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B2_9.23.18",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B2_9.23.18",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B4_9.26.18",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B4_9.26.18",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B3_9.27.18",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B3_9.27.18",], SPAR_SMOOTHINT=0.7) ##7
rq.state[rq.state$Run_ID=="B4_9.27.18",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B4_9.27.18",], SPAR_SMOOTHINT=0.75) #75
rq.state[rq.state$Run_ID=="B10_6.25.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B10_6.25.19",], SPAR_SMOOTHINT=0.7)
rq.state[rq.state$Run_ID=="B11_6.25.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B11_6.25.19",], SPAR_SMOOTHINT=0.3) #3
rq.state[rq.state$Run_ID=="B12_6.26.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B12_6.26.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B10_6.27.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B10_6.27.19",], SPAR_SMOOTHINT=0.7) #7
rq.state[rq.state$Run_ID=="B11_6.29.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B11_6.29.19",], SPAR_SMOOTHINT=0.8) #8
rq.state[rq.state$Run_ID=="B13_6.29.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B13_6.29.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B14_6.29.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B14_6.29.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B13_7.2.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B13_7.2.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B14_7.2.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B14_7.2.19",], SPAR_SMOOTHINT=0.7)
rq.state[rq.state$Run_ID=="B12_7.7.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B12_7.7.19",], SPAR_SMOOTHINT=0.65)#BAD RUN- PROBS A LEAK- gets taken out --really? it looks fine?
rq.state[rq.state$Run_ID=="B15_7.7.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B15_7.7.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B8_7.9.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B8_7.9.19",], SPAR_SMOOTHINT=0.7)
rq.state[rq.state$Run_ID=="B9_7.9.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B9_7.9.19",], SPAR_SMOOTHINT=0.8)
rq.state[rq.state$Run_ID=="B10_7.9.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B10_7.9.19",], SPAR_SMOOTHINT=0.7)
rq.state[rq.state$Run_ID=="B6_7.10.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B6_7.10.19",], SPAR_SMOOTHINT=0.75)
rq.state[rq.state$Run_ID=="B15_7.10.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B15_7.10.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B9_7.18.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B9_7.18.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B13_7.18.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B13_7.18.19",], SPAR_SMOOTHINT=0.5)
rq.state[rq.state$Run_ID=="B14_7.18.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B14_7.18.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B12_7.21.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B12_7.21.19",], SPAR_SMOOTHINT=0.7)
rq.state[rq.state$Run_ID=="B15_7.21.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B15_7.21.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B16_7.21.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B16_7.21.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B10_7.23.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B10_7.23.19",],SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B13_7.23.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B13_7.23.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B16_7.23.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B16_7.23.19",], SPAR_SMOOTHINT=0.15)
rq.state[rq.state$Run_ID=="B12_7.25.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B12_7.25.19",], SPAR_SMOOTHINT=0.75)
rq.state[rq.state$Run_ID=="B16_7.25.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B16_7.25.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B17_7.25.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B17_7.25.19",], SPAR_SMOOTHINT=0.7)
rq.state[rq.state$Run_ID=="B8_7.29.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B8_7.29.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B11_7.29.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B11_7.29.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B14_7.29.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B14_7.29.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B6_8.9.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B6_8.9.19",], SPAR_SMOOTHINT=0.8)
rq.state[rq.state$Run_ID=="B7_8.9.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B7_8.9.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B10_8.9.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B10_8.9.19",], SPAR_SMOOTHINT=0.75)
rq.state[rq.state$Run_ID=="B11_8.10.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B11_8.10.19",], SPAR_SMOOTHINT=0.4)
rq.state[rq.state$Run_ID=="B12_8.10.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B12_8.10.19",], SPAR_SMOOTHINT=0.7)
rq.state[rq.state$Run_ID=="B17_8.10.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B17_8.10.19",], SPAR_SMOOTHINT=0.75)
rq.state[rq.state$Run_ID=="B8_8.11.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B8_8.11.19",], SPAR_SMOOTHINT=0.85)
rq.state[rq.state$Run_ID=="B13_8.11.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B13_8.11.19",], SPAR_SMOOTHINT=0.85)
rq.state[rq.state$Run_ID=="B14_8.12.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B14_8.12.19",], SPAR_SMOOTHINT=0.275)
rq.state[rq.state$Run_ID=="B15_8.12.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B15_8.12.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B16_8.12.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B16_8.12.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B18_8.14.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B18_8.14.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B20_8.14.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B20_8.14.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B11_8.20.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B11_8.20.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B13_8.24.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B13_8.24.19",], SPAR_SMOOTHINT=0.7)
rq.state[rq.state$Run_ID=="B16_8.24.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B16_8.24.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B17_8.24.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B17_8.24.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B10_8.31.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B10_8.31.19",], SPAR_SMOOTHINT=0.7)
rq.state[rq.state$Run_ID=="B14_8.31.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B14_8.31.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B10_9.1.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B10_9.1.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B10_9.2.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B10_9.2.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B13_9.2.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B13_9.2.19",], SPAR_SMOOTHINT=0.75)
rq.state[rq.state$Run_ID=="B9_9.3.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B9_9.3.19",], SPAR_SMOOTHINT=0.75)
rq.state[rq.state$Run_ID=="B9_9.4.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B9_9.4.19",], SPAR_SMOOTHINT=0.75)
rq.state[rq.state$Run_ID=="B12_9.4.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B12_9.4.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B14_9.4.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B14_9.4.19",], SPAR_SMOOTHINT=0.75)
rq.state[rq.state$Run_ID=="B9_9.5.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B9_9.5.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B12_9.5.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B12_9.5.19",], SPAR_SMOOTHINT=.8)
rq.state[rq.state$Run_ID=="B14_9.5.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B14_9.5.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B9_9.6.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B9_9.6.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B10_9.7.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B10_9.7.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B15_9.7.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B15_9.7.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B8_9.9.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B8_9.9.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B10_9.9.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B10_9.9.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B15_9.9.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B15_9.9.19",], SPAR_SMOOTHINT=0.7)
rq.state[rq.state$Run_ID=="B15_9.10.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B15_9.10.19",], SPAR_SMOOTHINT=0.5)
rq.state[rq.state$Run_ID=="B11_9.11.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B11_9.11.19",], SPAR_SMOOTHINT=0.8)
rq.state[rq.state$Run_ID=="B11_9.12.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B11_9.12.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B13_9.12.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B13_9.12.19",], SPAR_SMOOTHINT=0.75)
rq.state[rq.state$Run_ID=="B16_9.12.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B16_9.12.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B11_9.16.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B11_9.16.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B13_9.16.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B13_9.16.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B16_9.16.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B16_9.16.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B11_9.17.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B11_9.17.19",], SPAR_SMOOTHINT=0.65) #THIS NIGHT IS FUCKE DUP
rq.state[rq.state$Run_ID=="B13_9.17.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B13_9.17.19",], SPAR_SMOOTHINT=0.65) #THIS IGHT MIGHT BE FUCKE D UP
rq.state[rq.state$Run_ID=="B7_9.18.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B7_9.18.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B8_9.18.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B8_9.18.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B8_9.20.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B8_9.20.19",], SPAR_SMOOTHINT=0.7)
rq.state[rq.state$Run_ID=="B9_9.20.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B9_9.20.19",], SPAR_SMOOTHINT=0.75)
rq.state[rq.state$Run_ID=="B10_9.20.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B10_9.20.19",], SPAR_SMOOTHINT=0.75)
rq.state[rq.state$Run_ID=="B9_9.21.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B9_9.21.19",], SPAR_SMOOTHINT=0.75)
rq.state[rq.state$Run_ID=="B10_9.21.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B10_9.21.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B12_9.21.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B12_9.21.19",], SPAR_SMOOTHINT=0.7)
rq.state[rq.state$Run_ID=="B12_9.22.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B12_9.22.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B13_9.22.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B13_9.22.19",], SPAR_SMOOTHINT=0.8)
rq.state[rq.state$Run_ID=="B14_9.22.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B14_9.22.19",], SPAR_SMOOTHINT=0.8)
rq.state[rq.state$Run_ID=="B13_9.23.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B13_9.23.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B14_9.23.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B14_9.23.19",], SPAR_SMOOTHINT=0.8)
rq.state[rq.state$Run_ID=="B15_9.23.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B15_9.23.19",], SPAR_SMOOTHINT=0.75)
rq.state[rq.state$Run_ID=="B11_9.24.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B11_9.24.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B14_9.24.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B14_9.24.19",], SPAR_SMOOTHINT=0.65)
rq.state[rq.state$Run_ID=="B15_9.24.19",]<-TORPOR_smooth_state_func(rq.merged[rq.merged$Run_ID=="B15_9.24.19",], SPAR_SMOOTHINT=0.65)

################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################

#GENERATE THE SECOND STATE FUNCTION WHICH ASSIGNS REAL STATES BASED ON 2 SEPARATE SPLINES. 

TORPOR_smooth2_state_func<-function(RUN_ID, SPARA,SPARB, ENTRY_CUTOFF,AROUSAL_CUTOFF){
    ############################################################################

    #FIRST GENERATE VECTORS OF INTERPOLATED, SMOOTHED VO2 DATA AND ITS SLOPE
    #FOR 2 SEPARATE SPLINES- A IS FOR ENTRY, B IS FOR AROUSAL.
  
    ############################################################################
  
    #interpolate data linearly
    RUN_ID$VO2_int2<-na.approx(RUN_ID$VO2, x=RUN_ID$Minute_Elapsed, na.rm=F)#,rule=2)
    #plot(RUN_ID$VO2_int)

    ############################################################################

    #ENTRY SMOOTH
    #generate a spline model to smooth interpolated data
    splinemod.a.vo2<-smooth.spline(RUN_ID$VO2_int2[is.na(RUN_ID$VO2_int2)==F&RUN_ID$Minute_Elapsed<RUN_ID$Torpor_End],
                          x=RUN_ID$Minute_Elapsed[is.na(RUN_ID$VO2_int)==F&RUN_ID$Minute_Elapsed<RUN_ID$Torpor_End],
                            spar=SPARA) 
    
    #generate smoothed VO2 data for each minute, based on above spline model
    predmodela<- predict(splinemod.a.vo2, x=seq(0,RUN_ID$Torpor_End[1], length=RUN_ID$Torpor_End[1])) 
    RUN_ID$VO2_smootha<-NA
    RUN_ID$VO2_smootha[0:RUN_ID$Torpor_End[1]] <-predmodela$y[0:RUN_ID$Torpor_End[1]] 
    #plot(predmodela)
    
    #generate the first derivative (slope) of smoothed VO2 data for each minute, based on above spline model
    predmodela_deriv<- predict(splinemod.a.vo2,deriv=1, x=seq(0,RUN_ID$Torpor_End[1], length=RUN_ID$Torpor_End[1])) 
    RUN_ID$VO2_smootha_deriv<-NA
    RUN_ID$VO2_smootha_deriv[0:RUN_ID$Torpor_End[1]] <-predmodela_deriv$y[0:RUN_ID$Torpor_End[1]] 
    #plot(predmodela_deriv)

    ############################################################################
    
    #AROUSAL SMOOTH
    #generate a spline model to smooth interpolated data
    splinemod.b.vo2<-smooth.spline(RUN_ID$VO2_int[is.na(RUN_ID$VO2_int)==F&RUN_ID$Minute_Elapsed>=RUN_ID$Torpor_End],
                          x=RUN_ID$Minute_Elapsed[is.na(RUN_ID$VO2_int)==F&RUN_ID$Minute_Elapsed>=RUN_ID$Torpor_End],
                            spar=SPARB)
    
    #generate smoothed VO2 data for each minute, based on above spline model
    predmodelb<- predict(splinemod.b.vo2, x=seq(RUN_ID$Torpor_End[1],length(RUN_ID$Minute_Elapsed), length=length(RUN_ID$Minute_Elapsed)-RUN_ID$Torpor_End[1])) 
    RUN_ID$VO2_smoothb<-NA
    RUN_ID$VO2_smoothb[RUN_ID$Minute_Elapsed>=RUN_ID$Torpor_End[1]&RUN_ID$Minute_Elapsed<=length(RUN_ID$Minute_Elapsed)] <-predmodelb$y[predmodelb$x>=RUN_ID$Torpor_End[1] &predmodelb$x<=length(RUN_ID$Minute_Elapsed)] 
    #plot(predmodelb)

    #generate the first derivative (slope) of smoothed VO2 data for each minute, based on above spline model
    predmodelb_deriv<- predict(splinemod.b.vo2, deriv=1, x=seq(RUN_ID$Torpor_End[1],length(RUN_ID$Minute_Elapsed), length=length(RUN_ID$Minute_Elapsed)-RUN_ID$Torpor_End[1])) 
    RUN_ID$VO2_smoothb_deriv<-NA
    RUN_ID$VO2_smoothb_deriv[RUN_ID$Minute_Elapsed>=RUN_ID$Torpor_End[1]&RUN_ID$Minute_Elapsed<=length(RUN_ID$Minute_Elapsed)] <-predmodelb_deriv$y[predmodelb$x>=RUN_ID$Torpor_End[1] &predmodelb_deriv$x<=length(RUN_ID$Minute_Elapsed)] 
    #plot(predmodelb_deriv)

    ############################################################################

    ##Generate a plot to check the smoothed and derivitive data for both splines
    #ggplot(data=RUN_ID)+
    # geom_point(aes(x=Minute_Elapsed,y=VO2_smootha), col="blue", lwd=3, alpha=.6)+
    # geom_point(aes(x=Minute_Elapsed,y=VO2_smootha_deriv), col="blue", lwd=3, alpha=.6)+
    # geom_point(aes(x=Minute_Elapsed,y=VO2_smoothb), col="red", lwd=3, alpha=.6)+
    # geom_point(aes(x=Minute_Elapsed,y=VO2_smoothb_deriv), col="red", lwd=3, alpha=.6)+
    # geom_point(aes(x=Minute_Elapsed,y=VO2), col="black")+
    #my_theme
 
    ################################################################################    
    ################################################################################
    ################################################################################    
    ################################################################################
    ################################################################################    
      
    #CALCULATE ENTRY AND AROUSAL CUTOFF VALUES
    
    ############################################################################
    
    #ENTRY CUTOFF
    #calculate the mean slope of the smoothed VO2 during the normothermic pre period (spline a)
    VO2_normopre_deriv_mean<-mean(RUN_ID$VO2_smootha_deriv[RUN_ID$State=="NORMOPRE"],na.rm=T)
    VO2_normopre_deriv_sd<-sd(RUN_ID$VO2_smootha_deriv[RUN_ID$State=="NORMOPRE"],na.rm=T)
    
    #calculate the entry cut off as the mean slope of the normothermic period plus 2 standard deviations
    ENTRY_CUTOFF<- -1*(VO2_normopre_deriv_mean+VO2_normopre_deriv_sd*2)
    RUN_ID$Entry_Cutoff<-ENTRY_CUTOFF
    
    #in the cases (10ish) where there is minimal or no normothermic pre period, 
    #use the average entry cutoff for the other birds, which i manually calculated
    #outside this function, excluding the problematic nights.
    if(RUN_ID$NormoPre_Prob[1]=="NoPre"){
        RUN_ID$Entry_Cutoff<- -0.0022
        ENTRY_CUTOFF<- -0.0022}
    
    ############################################################################
    
    #AROUSAL CUTOFF
    #calculate the mean slope of the smoothed VO2 during the torpid period (spline a)
    VO2_torpor_deriv_mean<-mean(RUN_ID$VO2_smootha_deriv[RUN_ID$State=="TORPOR"],na.rm=T)
    VO2_torpor_deriv_sd<-sd(RUN_ID$VO2_smootha_deriv[RUN_ID$State=="TORPOR"],na.rm=T)
    
    #calculate the arousal cut off as the mean slope of the torpid period plus 5 standard deviations
    AROUSAL_CUTOFF<-(VO2_torpor_deriv_mean+VO2_torpor_deriv_sd*5)
    RUN_ID$Arousal_Cutoff<-AROUSAL_CUTOFF
    
    ############################################################################
    ############################################################################
    ############################################################################
    ############################################################################
    ############################################################################
    
    #ANNOTATE EACH MINUTE OF VO2 WITH A STABILITY LABEL BASED ON ITS RATE OF CHANGE
    #AND THE CUTOFF VALUES

    RUN_ID$Stability2<-"STABLE" #make everything stable to start
    
    #label everything with a slope of less than than the cutoff as "DECREASING"
    RUN_ID$Stability2[RUN_ID$VO2_smootha_deriv < ENTRY_CUTOFF] <- "DECREASING"#ENTRY_CUTOFF
    
    #label everything with a slope of greater than than the cutoff as "INCREASING"
    RUN_ID$Stability2[RUN_ID$VO2_smoothb_deriv > AROUSAL_CUTOFF] <-"INCREASING"

    #copy the stability labels to STATE
    RUN_ID$State2<-RUN_ID$Stability2
    
    #generate a plot to check that the stability is working right
    #ggplot(data=RUN_ID)+
    #  geom_point(aes(x=Minute_Elapsed, y=VO2), col="black",lwd=2)+
    #  geom_point(aes(x=Minute_Elapsed, y=VO2_smootha_deriv, col=Stability2))+
    #  geom_point(aes(x=Minute_Elapsed, y=VO2_smootha, col=Stability2),lwd=2 ,alpha=.9)+
    #  geom_point(aes(x=Minute_Elapsed, y=VO2_smoothb_deriv, col=Stability2))+
    #  geom_point(aes(x=Minute_Elapsed, y=VO2_smoothb, col=Stability2),lwd=2 ,alpha=.9)+
    #  geom_line(aes(x=Minute_Elapsed, y=VO2_int), col="black")+
    #  geom_hline(yintercept = 0, col="black")+
    #  scale_color_brewer(palette="Set1")+
    #  my_theme  #+ theme(legend.position = "none")
    
    ############################################################################
    ############################################################################
    ############################################################################
    ############################################################################
    ############################################################################
    
    #ANNOTATE EACH MINUTE OF VO2 WITH A STATE LABEL BASED ON THE STABILITY AND THE LOGICAL ORDER OF TORPOR
    
    ############################################################################
    
    #Within the torpor nights, there are a few differnet patterns based on 
    #time resolution and data completeness. #these require slightly different
    #criteria/logic to label properly
    #1. Full nights where there is a full normal pattern 
    #2. NoPre nights with no or minimal pretorpor values (when the bird starts torpor pretty much immediately) 
    #3. NoPost night with no or minimal post torpor values
    #4. Dip nights when the bird never reaches stable torpor
    #5. Double torpor nights. #THESE CURRENTLY DONT WORK so it is commented out AND ARE TAKEN OUT IN LATER ANALYSES. 
    
    #THE FOLLOWING ARE  IF/ELSEIF STATEMENTS DEPENDING OF WHAT TORPOR_TYPE
    #ASSIGN STATES
    #WITHIN TORPOR NIGHTS, THERE ARE A FEW DIFFERENT TYPES
    #THE FOLLOWING is an IF/ELSEIF STATEMENT DEPENDING OF WHAT TORPOR_TYPE
    #TORPOR TYPE CAN BE FULL, NO PRE, NO POST, DIP. DOUBLES ARE TOTALLY TAKEN OUT FOR NOW

    ############################################################################
    
    #FULL TORPOR 
    if(RUN_ID$Torpor_Type[1]=="Full"){

        #where vo2 INCREASING and min elapsed is AFTER the 1st stable period, label as AROUSAL
        RUN_ID$State2[RUN_ID$Stability2=="INCREASING" &
                      RUN_ID$Minute_Elapsed >= first(RUN_ID$Minute_Elapsed[RUN_ID$Stability2=="STABLE"])]<-"AROUSAL"
          
        #where VO2 STABLE, and min elapsed is before the start of entry, as "NORMOPRE"
        RUN_ID$State2[RUN_ID$Stability2== "STABLE" & 
                      RUN_ID$Minute_Elapsed <= last(RUN_ID$Minute_Elapsed[RUN_ID$Stability2=="DECREASING"])] <- "NORMOPRE" 
          
        #where VO2 stable, and min elapsed is after the start of AROUSAL, as "NORMOPOST"
        RUN_ID$State2[RUN_ID$Stability2== "STABLE" &
                       RUN_ID$Minute_Elapsed >= last(RUN_ID$Minute_Elapsed[RUN_ID$Stability2=="INCREASING"])] <- "NORMOPOST" 
         
        #where VO2 is DECREASING, and min elapsed is BEFORE THE START OF NORMOPRE , as "FREAKOUT"
        RUN_ID$State2[RUN_ID$State2== "DECREASING" & 
                      RUN_ID$Minute_Elapsed <= first(RUN_ID$Minute_Elapsed[RUN_ID$State2=="NORMOPRE"])] <- "FREAKOUT" 
          
        #where VO2 is DECREASING, and min elapsed is AFTER the start of entry, as "ENTRY"
        RUN_ID$State2[RUN_ID$State2== "DECREASING" & 
                       RUN_ID$Minute_Elapsed >= last(RUN_ID$Minute_Elapsed[RUN_ID$State2=="NORMOPRE"])] <- "ENTRY" 
          
        #where VO2 stable, and min elapsed is AFTER the end of entry, and BEFORE the start of arousal, as TORPOR
        RUN_ID$State2[RUN_ID$Minute_Elapsed <= (first(RUN_ID$Minute_Elapsed[RUN_ID$State2=="AROUSAL"])) &
                       RUN_ID$Minute_Elapsed >= (last(RUN_ID$Minute_Elapsed[RUN_ID$State2=="ENTRY"]))] <- "TORPOR" 
        (RUN_ID$State2)

      }#END FULL TORPOR

    ############################################################################

    #DIP 
    else if(RUN_ID$Torpor_Type[1]=="Dip"){ 

        #where vo2 INCREASING and min elapsed is AFTER the 1st stable period, label as AROUSAL
        RUN_ID$State2[RUN_ID$Stability2=="INCREASING" &
                    RUN_ID$Minute_Elapsed >= first(RUN_ID$Minute_Elapsed[RUN_ID$Stability2=="STABLE"])]<-"AROUSAL"
          
        #where VO2 STABLE, and min elapsed is before the start of entry, as "NORMOPRE"
        RUN_ID$State2[RUN_ID$Stability2== "STABLE" & 
                      RUN_ID$Minute_Elapsed <= last(RUN_ID$Minute_Elapsed[RUN_ID$Stability2=="DECREASING"])] <- "NORMOPRE" 
          
        #where VO2 stable, and min elapsed is before the start of AROUSAL, as "NORMOPOST"
        RUN_ID$State2[RUN_ID$Stability2== "STABLE" &
                       RUN_ID$Minute_Elapsed >= last(RUN_ID$Minute_Elapsed[RUN_ID$Stability2=="INCREASING"])] <- "NORMOPOST" 
          
        #where VO2 is DECREASING, and min elapsed is BEFORE THE START OF NORMOPRE , as "FREAKOUT"
        RUN_ID$State2[RUN_ID$State2== "DECREASING" & 
                       RUN_ID$Minute_Elapsed <= first(RUN_ID$Minute_Elapsed[RUN_ID$State2=="NORMOPRE"])] <- "FREAKOUT" 
          
        #where VO2 is DECREASING, and min elapsed is AFTER the start of entry, as "ENTRY"
        RUN_ID$State2[RUN_ID$State2== "DECREASING" & 
                       RUN_ID$Minute_Elapsed >= last(RUN_ID$Minute_Elapsed[RUN_ID$State2=="NORMOPRE"])] <- "ENTRY" 
        
        #where VO2 stable, and min elapsed is AFTER the end of entry, and BEFORE the start of arousal, as TORPOR
        RUN_ID$State2[RUN_ID$Minute_Elapsed <= (first(RUN_ID$Minute_Elapsed[RUN_ID$State2=="AROUSAL"])) &
                       RUN_ID$Minute_Elapsed >= (last(RUN_ID$Minute_Elapsed[RUN_ID$State2=="ENTRY"]))] <- "TORPOR" 
          
    }#END DIP

    ############################################################################
    
    #NOPOST
    else if(RUN_ID$Torpor_Type[1]=="NoPost"){

        #where vo2 INCREASING and min elapsed is AFTER the 1st stable period, label as AROUSAL
        RUN_ID$State2[RUN_ID$Stability2=="INCREASING" &
                      RUN_ID$Minute_Elapsed >= first(RUN_ID$Minute_Elapsed[RUN_ID$Stability2=="STABLE"])]<-"AROUSAL"
          
        #where VO2 STABLE, and min elapsed is before the start of entry, as "NORMOPRE"
        RUN_ID$State2[RUN_ID$Stability2== "STABLE" & 
                      RUN_ID$Minute_Elapsed <= last(RUN_ID$Minute_Elapsed[RUN_ID$Stability2=="DECREASING"])] <- "NORMOPRE" 
          
        #where VO2 stable, and min elapsed is before the start of AROUSAL, as "NORMOPOST"
        # RUN_ID$State2[RUN_ID$Stability2== "STABLE" &
        #                RUN_ID$Minute_Elapsed >= last(RUN_ID$Minute_Elapsed[RUN_ID$Stability2=="INCREASING"])] <- "NORMOPOST" 
        RUN_ID$State2[RUN_ID$Minute_Elapsed>length(RUN_ID$Minute_Elapsed)-2] <- "NORMOPOST" 
        RUN_ID$State2[RUN_ID$Minute_Elapsed>length(RUN_ID$Minute_Elapsed)-3] <- "NORMOPOST" 

        #where VO2 is DECREASING, and min elapsed is BEFORE THE START OF NORMOPRE , as "FREAKOUT"
        RUN_ID$State2[RUN_ID$State2== "DECREASING" & 
                     RUN_ID$Minute_Elapsed <= first(RUN_ID$Minute_Elapsed[RUN_ID$State2=="NORMOPRE"])] <- "FREAKOUT" 
          
        #where VO2 is DECREASING, and min elapsed is AFTER the start of entry, as "ENTRY"
        RUN_ID$State2[RUN_ID$State2== "DECREASING" & 
                       RUN_ID$Minute_Elapsed >= last(RUN_ID$Minute_Elapsed[RUN_ID$State2=="NORMOPRE"])] <- "ENTRY" 
          
        #where VO2 stable, and min elapsed is AFTER the end of entry, and BEFORE the start of arousal, as TORPOR
        RUN_ID$State2[RUN_ID$Minute_Elapsed <= (first(RUN_ID$Minute_Elapsed[RUN_ID$State2=="AROUSAL"])) &
                       RUN_ID$Minute_Elapsed >= (last(RUN_ID$Minute_Elapsed[RUN_ID$State2=="ENTRY"]))] <- "TORPOR" 
          
    }#END NOPOST
              
    ############################################################################
    
    #NO PRE TORPOR NORMOTHERMY
    else if(RUN_ID$Torpor_Type[1]=="NoPre"){ 
        
      #where vo2 INCREASING and min elapsed is AFTER the 1st stable period, label as AROUSAL
      RUN_ID$State2[RUN_ID$Stability2=="INCREASING" &
                    RUN_ID$Minute_Elapsed >= first(RUN_ID$Minute_Elapsed[RUN_ID$Stability2=="STABLE"])]<-"AROUSAL"
          
      #since htere is no stable period in nopres, just mark the first row (really the 0 row) as NORMOPRE
      RUN_ID$State2[RUN_ID$Minute_Elapsed<1] <- "NORMOPRE" 
        
      #Since There is no stable period in nopres, just mark the first row (really the 0 row) as NORMOPRE
      RUN_ID$State2[RUN_ID$Minute_Elapsed<1] <- "NORMOPRE" 

      #where VO2 stable, and min elapsed is before the start of AROUSAL, as "NORMOPOST"
      RUN_ID$State2[RUN_ID$Minute_Elapsed>length(RUN_ID$Minute_Elapsed)-2] <- "NORMOPOST" 
          
      ##theres not going to be freakouts in these nopre nights
      #where VO2 is DECREASING, and min elapsed is BEFORE THE START OF NORMOPRE , as "FREAKOUT"
      #RUN_ID$State2[RUN_ID$State2== "DECREASING" & 
      #               RUN_ID$Minute_Elapsed <= first(RUN_ID$Minute_Elapsed[RUN_ID$State2=="NORMOPRE"])] <- "FREAKOUT" 
          
      #where VO2 is DECREASING, and min elapsed is AFTER the start of entry, as "ENTRY"
      RUN_ID$State2[RUN_ID$State2== "DECREASING" & 
                     RUN_ID$Minute_Elapsed >= last(RUN_ID$Minute_Elapsed[RUN_ID$State2=="NORMOPRE"])] <- "ENTRY" 
          
      #where VO2 stable, and min elapsed is AFTER the end of entry, and BEFORE the start of arousal, as TORPOR
      RUN_ID$State2[RUN_ID$Minute_Elapsed <= (first(RUN_ID$Minute_Elapsed[RUN_ID$State2=="AROUSAL"])) &
                       RUN_ID$Minute_Elapsed >= (last(RUN_ID$Minute_Elapsed[RUN_ID$State2=="ENTRY"]))] <- "TORPOR" 
      
      #where VO2 STABLE, and min elapsed is before the start of entry, as "NORMOPRE"
      RUN_ID$State2[RUN_ID$Stability2== "STABLE" & 
                    RUN_ID$Minute_Elapsed <= first(RUN_ID$Minute_Elapsed[RUN_ID$State2=="ENTRY"])] <- "NORMOPRE" 
    }#END OF_______
    
    ############################################################################
    
  #   #DOUBLE TORPOR 
  #   else if(RUN_ID$Torpor_Type[1]=="Double"){
  #       
  #     #where vo2 INCREASING and min elapsed is AFTER the 1st stable period, label as AROUSAL
  #     RUN_ID$State2[RUN_ID$Stability2=="INCREASING" &
  #                   RUN_ID$Minute_Elapsed >= first(RUN_ID$Minute_Elapsed[RUN_ID$Stability2=="STABLE"])]<-"AROUSAL"
  #         
  #     #where VO2 STABLE, and min elapsed is before the start of entry, as "NORMOPRE"
  #     RUN_ID$State2[RUN_ID$Stability2== "STABLE" & 
  #                   RUN_ID$Minute_Elapsed <= first(RUN_ID$Minute_Elapsed[RUN_ID$Stability2=="DECREASING"])] <- "NORMOPRE" 
  #                                             #having this as first and not last might fuckup for freakout nights
  #      
  #      #where VO2 stable, and min elapsed is before the start of AROUSAL, as "NORMOPOST"
  #       RUN_ID$State2[RUN_ID$Minute_Elapsed>length(RUN_ID$Minute_Elapsed)-2] <- "NORMOPOST" 
  #       
  #     # RUN_ID$State2[RUN_ID$Stability2== "STABLE" &
  #     #                RUN_ID$Minute_Elapsed >= last(RUN_ID$Minute_Elapsed[RUN_ID$Stability2=="INCREASING"])] <- "NORMOPOST" 
  #     #this particular night doest have a post, so need to add it to the last row. 
  #     
  #     #thi snight dont have a freakout so take it out 
  #     #where VO2 is DECREASING, and min elapsed is BEFORE THE START OF NORMOPRE , as "FREAKOUT"
  #     # RUN_ID$State2[RUN_ID$State2== "DECREASING" & 
  #     #                RUN_ID$Minute_Elapsed <= first(RUN_ID$Minute_Elapsed[RUN_ID$State2=="NORMOPRE"])] <- "FREAKOUT" 
  #       
  #     #where VO2 is DECREASING, and min elapsed is AFTER the start of entry, as "ENTRY"
  #     RUN_ID$State2[RUN_ID$State2== "DECREASING" & 
  #                    RUN_ID$Minute_Elapsed >= last(RUN_ID$Minute_Elapsed[RUN_ID$State2=="NORMOPRE"])] <- "ENTRY" 
  #       
  #     #where VO2 stable, and min elapsed is AFTER the end of entry, and BEFORE the start of arousal, as TORPOR
  #     RUN_ID$State2[RUN_ID$State2== "STABLE" &
  #                   RUN_ID$Minute_Elapsed <= (first(RUN_ID$Minute_Elapsed[RUN_ID$State2=="AROUSAL"])) &
  #                     RUN_ID$Minute_Elapsed >= (first(RUN_ID$Minute_Elapsed[RUN_ID$State2=="ENTRY"]))] <- "TORPOR1" 
  #       
  #     RUN_ID$State2[RUN_ID$State2== "STABLE" &
  #                   RUN_ID$Minute_Elapsed > (last(RUN_ID$Minute_Elapsed[RUN_ID$State2=="ENTRY"])) &
  #                     RUN_ID$Minute_Elapsed <= (last(RUN_ID$Minute_Elapsed[RUN_ID$State2=="AROUSAL"]))] <- "TORPOR2" 
  #     
  #     RUN_ID$State2[RUN_ID$State2== "STABLE" &
  #                   RUN_ID$Minute_Elapsed > (first(RUN_ID$Minute_Elapsed[RUN_ID$State2=="AROUSAL"])) &
  #                     RUN_ID$Minute_Elapsed <= (last(RUN_ID$Minute_Elapsed[RUN_ID$State2=="ENTRY"]))] <- "NORMOMID" 
  #     
  #     RUN_ID$State2[RUN_ID$State2== "ENTRY" & 
  #                   RUN_ID$Minute_Elapsed <=first(RUN_ID$Minute_Elapsed[RUN_ID$State2=="TORPOR1"])] <- "ENTRY1" 
  #       
  #     RUN_ID$State2[RUN_ID$State2== "ENTRY" & 
  #                   RUN_ID$Minute_Elapsed >=last(RUN_ID$Minute_Elapsed[RUN_ID$State2=="TORPOR1"])] <- "ENTRY2" 
  #     RUN_ID$State2[RUN_ID$State2== "AROUSAL" & 
  #                   RUN_ID$Minute_Elapsed <=first(RUN_ID$Minute_Elapsed[RUN_ID$State2=="TORPOR2"])] <- "AROUSAL1" 
  #       
  #     RUN_ID$State2[RUN_ID$State2== "AROUSAL" & 
  #                   RUN_ID$Minute_Elapsed >=last(RUN_ID$Minute_Elapsed[RUN_ID$State2=="TORPOR2"])] <- "AROUSAL2" 

  #   }#END DOUBLE TORPOR
    
    ############################################################################
    ############################################################################
    
    #RESTRUCTURE STATE AS A FACTOR
    #The above messes some structures up, this corrects it. 

    RUN_ID$State2<-factor(RUN_ID$State2, levels=c("FREAKOUT","NORMOPRE","ENTRY","TORPOR","AROUSAL", "NORMOPOST"),ordered=F)
    RUN_ID$State2<-as.character(RUN_ID$State2)
    
    #END STATE ANNOTATIONS 
    #################################################################################     
    #################################################################################     
    #################################################################################     
    #################################################################################     
    #################################################################################     

    #CALCULATE SEVERAL SPECIFIC VALUES FOR EACH NIGHT AND SAVE THEM TO RUN_ID
  
    #################################################################################     

    #Create vectors of single values for the boundaries of each state period
    RUN_ID$Freak_Start<-min(RUN_ID$Minute_Elapsed[RUN_ID$State2=="FREAKOUT"],na.rm=T)
    RUN_ID$Freak_End<-max(RUN_ID$Minute_Elapsed[RUN_ID$State2=="FREAKOUT"],na.rm=T)
    RUN_ID$Normopre_Start<-min(RUN_ID$Minute_Elapsed[RUN_ID$State2=="NORMOPRE"],na.rm=T)
    RUN_ID$Normopre_End<-max(RUN_ID$Minute_Elapsed[RUN_ID$State2=="NORMOPRE"],na.rm=T)
    RUN_ID$Entry_Start<-min(RUN_ID$Minute_Elapsed[RUN_ID$State2=="ENTRY"],na.rm=T)
    RUN_ID$Entry_End<-max(RUN_ID$Minute_Elapsed[RUN_ID$State2=="ENTRY"],na.rm=T)
    RUN_ID$Torpor_Start<-min(RUN_ID$Minute_Elapsed[RUN_ID$State2=="TORPOR"],na.rm=T)
    RUN_ID$Torpor_End<-max(RUN_ID$Minute_Elapsed[RUN_ID$State2=="TORPOR"],na.rm=T)
    RUN_ID$Arousal_Start<-min(RUN_ID$Minute_Elapsed[RUN_ID$State2=="AROUSAL"],na.rm=T)
    RUN_ID$Arousal_End<-max(RUN_ID$Minute_Elapsed[RUN_ID$State2=="AROUSAL"],na.rm=T)
    RUN_ID$Normopost_Start<-min(RUN_ID$Minute_Elapsed[RUN_ID$State2=="NORMOPOST"],na.rm=T)
    RUN_ID$Normopost_End<-max(RUN_ID$Minute_Elapsed[RUN_ID$State2=="NORMOPOST"],na.rm=T)
    
    ###########################################################################3
    
    #Calculate the absolute amount of time (currenlty in minutes) in each state
    RUN_ID$Pre_Duration<-RUN_ID$Normopre_End-RUN_ID$MinElapsed_LOFF
    RUN_ID$Entry_Duration<-RUN_ID$Entry_End-RUN_ID$Entry_Start
    RUN_ID$Torpor_Duration<-RUN_ID$Torpor_End-RUN_ID$Torpor_Start
    RUN_ID$Arousal_Duration<-RUN_ID$Arousal_End-RUN_ID$Arousal_Start #this is currently garbage b.c. the state function doesnt do well with the arousal
    RUN_ID$Post_Duration<-RUN_ID$Normopost_End-RUN_ID$Normopost_Start
    RUN_ID$Night_Duration<-RUN_ID$MinElapsed_LON
    
    ###########################################################################
    
    #Calculate a time vector relative to each nights duraiton
    RUN_ID$Time_p<- (RUN_ID$Minute_Elapsed/RUN_ID$Night_Duration)*100
    
    ###########################################################################
    
    #Calculate the time amount of time in p that the bird transitioned to and from each key state
    #RUN_ID$Time_p_LOFF<-RUN_ID$Minute_Elapsed[RUN_ID$Minute_Elapsed==RUN_ID$MinElapsed_LOFF[1]]/RUN_ID$Night_Duration#SHOUDL BE 0%
    RUN_ID$Time_p_Entry_Start<-RUN_ID$Minute_Elapsed[RUN_ID$Minute_Elapsed==RUN_ID$Entry_Start[1]]/RUN_ID$Night_Duration*100
    RUN_ID$Time_p_Entry_End<-RUN_ID$Minute_Elapsed[RUN_ID$Minute_Elapsed==RUN_ID$Entry_End[1]]/RUN_ID$Night_Duration*100
    RUN_ID$Time_p_Torpor_Start<-RUN_ID$Minute_Elapsed[RUN_ID$Minute_Elapsed==RUN_ID$Torpor_Start[1]]/RUN_ID$Night_Duration*100
    RUN_ID$Time_p_Torpor_End<-RUN_ID$Minute_Elapsed[RUN_ID$Minute_Elapsed==RUN_ID$Torpor_End[1]]/RUN_ID$Night_Duration*100
    RUN_ID$Time_p_Arousal_Start<-RUN_ID$Minute_Elapsed[RUN_ID$Minute_Elapsed==RUN_ID$Arousal_Start[1]]/RUN_ID$Night_Duration*100
    RUN_ID$Time_p_Arousal_End<-RUN_ID$Minute_Elapsed[RUN_ID$Minute_Elapsed==RUN_ID$Arousal_End[1]]/RUN_ID$Night_Duration*100
    #RUN_ID$Time_p_LON<-RUN_ID$Minute_Elapsed[RUN_ID$Minute_Elapsed==RUN_ID$MinElapsed_LON[1]]/RUN_ID$Night_Duration#SHOUDL BE 0%
    
    ###########################################################################
    
    #calculate % of the night spent in each State2 
    RUN_ID$Pre_Percent_Night<- RUN_ID$Pre_Duration/ RUN_ID$Night_Duration
    RUN_ID$Entry_Percent_Night<-RUN_ID$Entry_Duration/ RUN_ID$Night_Duration
    RUN_ID$Torpor_Percent_Night<-RUN_ID$Torpor_Duration/ RUN_ID$Night_Duration
    RUN_ID$Arousal_Percent_Night<-RUN_ID$Arousal_Duration/ RUN_ID$Night_Duration
    RUN_ID$Post_Percent_Night<-RUN_ID$Post_Duration/ RUN_ID$Night_Duration
    #if i decide i dont want these numbers
    # RUN_ID$Pre_Percent_Night<- NA
    # RUN_ID$Entry_Percent_Night<-NA
    # RUN_ID$Torpor_Percent_Night<-NA
    # RUN_ID$Arousal_Percent_Night<-NA
    # RUN_ID$Post_Percent_Night<-NA
    
  ###############################################################################    
  ###############################################################################    
  ###############################################################################    
  ###############################################################################    
  ###############################################################################    

  #GENERATE A PLOT OF VO2 WITH RAW, SMOOTHED, AND DERIVITIVE DATA TO CHECK AND TO REPRESENT HOW STATE ANNOTATIONS WORKED

  plot<-ggplot(data=RUN_ID)+
    
    geom_point(aes(x=Minute_Elapsed, y=VO2_smootha,col=State2),lwd=6,alpha=.4)+
    geom_point(aes(x=Minute_Elapsed, y=VO2_smoothb,col=State2),lwd=6,alpha=.4)+

    scale_color_manual(values=c("FREAKOUT"="green","NORMOPRE"="red","ENTRY"="purple","TORPOR"="blue","AROUSAL"="orange","NORMOPOST"="red"))+

    geom_point(aes(x=Minute_Elapsed, y=VO2), col="black",lwd=3)+
    geom_line(aes(x=Minute_Elapsed, y=VO2_int), col="black",lwd=.5)+
    
    geom_line(aes(x=Minute_Elapsed, y=abs(VO2_smootha_deriv*20),col=State2), lwd=.5)+
    geom_line(aes(x=Minute_Elapsed, y=abs(VO2_smoothb_deriv*20),col=State2),lwd=.5)+
  
    scale_y_continuous(name="VO2 (ml/min)",breaks = seq(0, 5, by = .1), sec.axis = sec_axis(trans=~./20, name="Slope Of Smoothed VO2 (abs val)", breaks = seq(0, .1, by = .05)))+
    scale_x_continuous(name="Time, Minutes Elapsed")+
  
    geom_hline(yintercept=-ENTRY_CUTOFF*20, col="blue", lwd=1, linetype=1)+
    geom_hline(yintercept=AROUSAL_CUTOFF*20, col="red", lwd=1, linetype=3)+

    my_theme  +
      theme(axis.text.x = element_text(angle=0, size=16), legend.key.height = unit(3, 'lines'),
        panel.grid.major.y = element_line(color='white'),
        panel.grid.minor.y = element_line(color='white'))+
      theme(axis.text.y = element_text(angle=0, size=20), legend.key.height = unit(3, 'lines'),
        panel.grid.major.x = element_line(color='white'), 
        panel.grid.minor.x = element_line(color='white'))
      
  #print(plot)

return(RUN_ID)  
}#END TORPOR State2 FUNCTION

################################################################################
################################################################################

#label a few nights with limited or no pre torpor data
rq.state$NormoPre_Prob<-"good"
rq.state$NormoPre_Prob[rq.state$Run_ID=="B11_6.25.19"]<-"NoPre"
rq.state$NormoPre_Prob[rq.state$Run_ID=="B12_6.26.19"]<-"NoPre"
rq.state$NormoPre_Prob[rq.state$Run_ID=="B14_6.29.19"]<-"NoPre"
rq.state$NormoPre_Prob[rq.state$Run_ID=="B14_7.18.19"]<-"NoPre"
rq.state$NormoPre_Prob[rq.state$Run_ID=="B11_7.29.19"]<-"NoPre"
rq.state$NormoPre_Prob[rq.state$Run_ID=="B11_8.10.19"]<-"NoPre"
rq.state$NormoPre_Prob[rq.state$Run_ID=="B16_8.12.19"]<-"NoPre"

#Set up rq.state2 to accept new variables generated in the state2 function
#copy rq.state over to rq.state2 to be filled by the state 2 function
rq.state2<-rq.state

rq.state2$VO2_int2<-NA
rq.state2$VO2_smootha<-NA
rq.state2$VO2_smootha_deriv<-NA
rq.state2$VO2_smoothb<-NA
rq.state2$VO2_smoothb_deriv<-NA
#rq.state2$NormoPre_Prob<-NA
rq.state2$Entry_Cutoff<-NA
rq.state2$Arousal_Cutoff<-NA
rq.state2$Stability2<-NA #2
rq.state2$State2<-NA #2

################################################################################
################################################################################

#RUN THE SECOND TORPOR STATE FUNCTION

################################################################################

#first run the dips

#shallow quick dip - good 
rq.state2[rq.state2$Run_ID=="B2_8.6.18",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B2_8.6.18",], SPARA=.6,SPARB=.5)
#shallow quick dip-good
rq.state2[rq.state2$Run_ID=="B3_9.23.18",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B3_9.23.18",], SPARA=.6,SPARB=.5)
#deep dip-GOOD
rq.state2[rq.state2$Run_ID=="B9_6.25.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B9_6.25.19",], SPARA=.6,SPARB=.5)
#shallow quick dip- D
rq.state2[rq.state2$Run_ID=="B7_7.10.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B7_7.10.19",], SPARA=.6,SPARB=.5)
#deep dip good
rq.state2[rq.state2$Run_ID=="B9_8.26.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B9_8.26.19",], SPARA=.6,SPARB=.5)
#deep dip -good
rq.state2[rq.state2$Run_ID=="B13_9.1.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B13_9.1.19",], SPARA=.6,SPARB=.5)
#shallow dip- good
rq.state2[rq.state2$Run_ID=="B14_9.6.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B14_9.6.19",], SPARA=.6,SPARB=.5)
#deep dip good
rq.state2[rq.state2$Run_ID=="B8_9.10.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B8_9.10.19",], SPARA=.6,SPARB=.5)

################################################################################

# DONT run doubles

# #double torpor- #fucking still not working
# rq.state2[rq.state2$Run_ID=="B5_9.2.18",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B5_9.2.18",])
# #double torpor -STILL FUCKED but gets taken out anyway
# rq.state2[rq.state2$Run_ID=="B5_9.8.18",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B5_9.8.18",])#THIS NIGHT GETS TAKEN OUT
# #no preAND DOUBLE#not working
# rq.state2[rq.state2$Run_ID=="B15_7.2.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B15_7.2.19",])
# #no pre AND DOUBLE- still not working
# rq.state2[rq.state2$Run_ID=="B16_7.7.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B16_7.7.19",])

################################################################################

#RUN FULL, NO PRE, AND NO POST NIGHTS 
#some notes
#the default spara and spar b are .6 and .5, though some require manual adjustment to work properly.
#the entry cutoff is set at mean normo pre + 2*sd normo pre
#the arousal cutoff is set at mean torpor + 5*sd torpor
#Currently this works well to identify the start of entry, and the end of torpor/ the start of arousal
#it doesnt work great to catch the post normothermic period- about half nights just get included with arousal
#but I dont currently need anything with arousal except the start of it. so I leave it where it is now, 
#as opposed to adjusting more sparb values to include the arousal and normothermic periods better. 

rq.state2[rq.state2$Run_ID=="B2_7.19.18",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B2_7.19.18",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B2_7.29.18",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B2_7.29.18",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B4_7.29.18",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B4_7.29.18",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B1_7.30.18",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B1_7.30.18",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B3_7.30.18",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B3_7.30.18",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B2_8.13.18",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B2_8.13.18",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B3_8.15.18",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B3_8.15.18",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B5_8.22.18",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B5_8.22.18",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B5_8.24.18",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B5_8.24.18",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B2_8.26.18",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B2_8.26.18",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B2_9.20.18",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B2_9.20.18",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B2_9.22.18",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B2_9.22.18",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B3_9.22.18",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B3_9.22.18",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B2_9.23.18",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B2_9.23.18",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B4_9.26.18",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B4_9.26.18",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B3_9.27.18",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B3_9.27.18",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B4_9.27.18",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B4_9.27.18",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B10_6.25.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B10_6.25.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B11_6.25.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B11_6.25.19",], SPARA=.2,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B12_6.26.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B12_6.26.19",], SPARA=.9,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B10_6.27.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B10_6.27.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B11_6.29.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B11_6.29.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B13_6.29.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B13_6.29.19",], SPARA=.8,SPARB=.8)
rq.state2[rq.state2$Run_ID=="B14_6.29.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B14_6.29.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B13_7.2.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B13_7.2.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B14_7.2.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B14_7.2.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B12_7.7.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B12_7.7.19",], SPARA=.6,SPARB=.5)#BAD RUN- PROBS A LEAK- gets taken out 
rq.state2[rq.state2$Run_ID=="B15_7.7.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B15_7.7.19",], SPARA=.5,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B8_7.9.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B8_7.9.19",], SPARA=.6,SPARB=.85)
rq.state2[rq.state2$Run_ID=="B9_7.9.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B9_7.9.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B10_7.9.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B10_7.9.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B6_7.10.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B6_7.10.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B15_7.10.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B15_7.10.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B9_7.18.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B9_7.18.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B13_7.18.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B13_7.18.19",], SPARA=.4,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B14_7.18.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B14_7.18.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B12_7.21.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B12_7.21.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B15_7.21.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B15_7.21.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B16_7.21.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B16_7.21.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B10_7.23.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B10_7.23.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B13_7.23.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B13_7.23.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B16_7.23.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B16_7.23.19",], SPARA=.5,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B12_7.25.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B12_7.25.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B16_7.25.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B16_7.25.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B17_7.25.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B17_7.25.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B8_7.29.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B8_7.29.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B11_7.29.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B11_7.29.19",], SPARA=.6,SPARB=.9)
rq.state2[rq.state2$Run_ID=="B14_7.29.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B14_7.29.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B6_8.9.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B6_8.9.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B7_8.9.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B7_8.9.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B10_8.9.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B10_8.9.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B11_8.10.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B11_8.10.19",], SPARA=.25,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B12_8.10.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B12_8.10.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B17_8.10.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B17_8.10.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B8_8.11.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B8_8.11.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B13_8.11.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B13_8.11.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B14_8.12.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B14_8.12.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B15_8.12.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B15_8.12.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B16_8.12.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B16_8.12.19",], SPARA=.8,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B18_8.14.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B18_8.14.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B20_8.14.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B20_8.14.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B11_8.20.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B11_8.20.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B13_8.24.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B13_8.24.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B16_8.24.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B16_8.24.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B17_8.24.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B17_8.24.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B10_8.31.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B10_8.31.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B14_8.31.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B14_8.31.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B10_9.1.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B10_9.1.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B10_9.2.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B10_9.2.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B13_9.2.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B13_9.2.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B9_9.3.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B9_9.3.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B9_9.4.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B9_9.4.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B12_9.4.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B12_9.4.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B14_9.4.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B14_9.4.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B9_9.5.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B9_9.5.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B12_9.5.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B12_9.5.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B14_9.5.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B14_9.5.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B9_9.6.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B9_9.6.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B10_9.7.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B10_9.7.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B15_9.7.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B15_9.7.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B8_9.9.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B8_9.9.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B10_9.9.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B10_9.9.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B15_9.9.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B15_9.9.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B15_9.10.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B15_9.10.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B11_9.11.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B11_9.11.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B11_9.12.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B11_9.12.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B13_9.12.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B13_9.12.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B16_9.12.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B16_9.12.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B11_9.16.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B11_9.16.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B13_9.16.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B13_9.16.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B16_9.16.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B16_9.16.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B11_9.17.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B11_9.17.19",], SPARA=.6,SPARB=.5) #THIS NIGHT IS FUCKE DUP
rq.state2[rq.state2$Run_ID=="B13_9.17.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B13_9.17.19",], SPARA=.6,SPARB=.5) #THIS IGHT MIGHT BE FUCKE D UP
rq.state2[rq.state2$Run_ID=="B7_9.18.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B7_9.18.19",], SPARA=.5,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B8_9.18.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B8_9.18.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B8_9.20.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B8_9.20.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B9_9.20.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B9_9.20.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B10_9.20.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B10_9.20.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B9_9.21.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B9_9.21.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B10_9.21.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B10_9.21.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B12_9.21.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B12_9.21.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B12_9.22.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B12_9.22.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B13_9.22.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B13_9.22.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B14_9.22.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B14_9.22.19",], SPARA=.7,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B13_9.23.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B13_9.23.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B14_9.23.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B14_9.23.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B15_9.23.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B15_9.23.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B11_9.24.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B11_9.24.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B14_9.24.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B14_9.24.19",], SPARA=.6,SPARB=.5)
rq.state2[rq.state2$Run_ID=="B15_9.24.19",]<-TORPOR_smooth2_state_func(rq.state[rq.state$Run_ID=="B15_9.24.19",], SPARA=.6,SPARB=.5)

################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################

#copy state2 over to state, saving over the first state function's preliminary annotations.
rq.state2$State<-rq.state2$State2

#rename all states where it was a normothermic night as NORMO. 
rq.state2$State[rq.state2$Torpor_Use=="NORMO"]<-"NORMO"

#fix structure of couple variables 
rq.state2$Entry_Duration<-as.numeric(rq.state2$Entry_Duration)
rq.state2$Torpor_Duration<-as.numeric(rq.state2$Torpor_Duration)

#CALCULATE an overall mean vo2  of normo pre state to be used in the torpor depth calculation
VO2_NORMO_MEAN<-mean(rq.state2$VO2[rq.state2$State=="NORMOPRE"],na.rm=T)
VO2_NORMO_MEAN

############################################################################################################################
############################################################################################################################
############################################################################################################################
############################################################################################################################
############################################################################################################################
############################################################################################################################
############################################################################################################################
############################################################################################################################
############################################################################################################################
############################################################################################################################
############################################################################################################################
############################################################################################################################
############################################################################################################################
############################################################################################################################
############################################################################################################################
############################################################################################################################
############################################################################################################################
############################################################################################################################
############################################################################################################################
############################################################################################################################

#ENERGETICS! 

############################################################################################################################

#GENERATE ENERGETICS FUNCITON 
#to test
# RUN_ID<-rq.state2[rq.state2$Run_ID=="B2_7.19.18",]

calc_energy_func <-function(RUN_ID) {
    ############################################################################
    
    #make sure run id is ordered properly so that integration functions will work right. 
    RUN_ID<-RUN_ID[order(RUN_ID$Minute_Elapsed),]
    
    ############################################################################
    ############################################################################
    
    #FIRST CALCULATE THE RATE OF ENERGY EXPENDITURE USING THE RER AND VO2
    
    #Create RER_bound , to bind RER between .71 and 1.0 for energy expenditure calculations 
    RUN_ID$RER_Bound<- RUN_ID$RER
    RUN_ID$RER_Bound[RUN_ID$RER<.71]<-.71
    RUN_ID$RER_Bound[RUN_ID$RER>1.0]<-1.0
    
    #calculate energy in kJ per minute
    oxyjul<-(16 + 5.164*(RUN_ID$RER_Bound)) 
    RUN_ID$VExpend<- oxyjul*(RUN_ID$VO2) * (1)/1000 
    
    ############################################################################
    ############################################################################
    
    #CALCULATE THE INSTANANEOUS FAT CONTENT AS A % OF BODY MASS

    #interpolate rate of energy expenditure 
    RUN_ID$Expend_Min_kJ<-na.approx(RUN_ID$VExpend,rule=2) 
    
    #convert rate of energy expenditure (in kJ/min) g of fat per min
    RUN_ID$Expend_Min_g<-  RUN_ID$Expend_Min_kJ/37

    #calculate the cumulative energy expenditure for each minute elapsed.
    RUN_ID$Expend_cumsum<-cumsum(RUN_ID$Expend_Min_kJ) 

    #convert evening and morning fat masses measured by qmr from grams of fat to kJ of fat  #37kJ/1gfat
    RUN_ID$Fat_Eve_kJ<-RUN_ID$Fat_Eve_g*37  
    RUN_ID$Fat_Morn_kJ<-RUN_ID$Fat_Morn_g*37
    
    #calculate instantaneous kJ of fat, then convert that to instantaneous grams of fat.
    RUN_ID$Fat_kJ<-RUN_ID$Fat_Eve_kJ - RUN_ID$Expend_cumsum
    
    #convert instantaneous kJ of fat to instantaneous grams of fat.
    RUN_ID$Fat_g <- RUN_ID$Fat_kJ/37
    
    #CALCULATE INSTANANEOUS FAT CONTENT AS A % OF BODY MASS (MORNING BODY MASS)
    RUN_ID$Fat_p<- RUN_ID$Fat_g/ RUN_ID$Body_Morn_g

    ############################################################################
    ############################################################################
    ############################################################################
    ############################################################################
    ############################################################################
    
    #The above is done for all nights, but there are some specific things that can only be done to torpor 
    #nights. so the below is an if statement that does one thing is the night is torpor, 
    #and another thing (mostly fills in blank variables with NA) on normothermic nights.

    if(RUN_ID$Torpor_Use[1]=="TORPOR"){
        
        #TORPOR SPECIFIC CALCULATIONS
      
        #Calculate how much energy was used during each period and overall by 
        #integrating under the rate of energy expenditure between the relevant bounds
        RUN_ID$Expend_Pre_kJ<-auc(RUN_ID$Minute_Elapsed, RUN_ID$VExpend, from=RUN_ID$MinElapsed_LOFF[1], to=RUN_ID$Entry_Start[1], type=c("spline"), subdivisions=3000)
        RUN_ID$Expend_Entry_kJ<-auc(RUN_ID$Minute_Elapsed, RUN_ID$VExpend, from=RUN_ID$Entry_Start[1], to=RUN_ID$Entry_End[1], type=c("spline"), subdivisions=3000)
        RUN_ID$Expend_Torpor_kJ<-auc(RUN_ID$Minute_Elapsed, RUN_ID$VExpend, from=RUN_ID$Torpor_Start[1], to=RUN_ID$Torpor_End[1], type=c("spline"), subdivisions=3000)
        RUN_ID$Expend_Arousal_kJ<-auc(RUN_ID$Minute_Elapsed, RUN_ID$VExpend, from=RUN_ID$Arousal_Start[1], to=RUN_ID$Arousal_End[1], type=c("spline"), subdivisions=3000)
        RUN_ID$Expend_Post_kJ<-auc(RUN_ID$Minute_Elapsed, RUN_ID$VExpend, from=RUN_ID$Arousal_End[1], to=last(RUN_ID$Minute_Elapsed), type=c("spline"), subdivisions=3000)
        RUN_ID$Expend_Total_kJ<-auc(RUN_ID$Minute_Elapsed, RUN_ID$VExpend, from=RUN_ID$MinElapsed_LOFF[1], to=last(RUN_ID$Minute_Elapsed), type=c("spline"), subdivisions=3000)

        ########################################################################
        
        #calculate fat content (in kJ) by subtracting energy expenditure before torpor entry from evening fat
        RUN_ID$Entry_Fat_kJ <- RUN_ID$Fat_Eve_kJ - RUN_ID$Expend_Pre_kJ 
  
        #convert amount of fat (in kJ) remaining at time of torpor entry to g of fat
        RUN_ID$Entry_Fat_g <- RUN_ID$Entry_Fat_kJ/37
        
        #calculate the threshold!! (assuming body mass in morning was similar to body mass at time of torpor entry)
        RUN_ID$Fat_Entry_p<-(RUN_ID$Entry_Fat_g[1]/RUN_ID$Body_Morn_g[1])*100

        #CALCLUATE FAT EXPENDITURE BEFORE TOPROR ENTRY
        RUN_ID$Fat_Loss_pretorpor_kJ<-RUN_ID$Expend_Pre_kJ

        ########################################################################
        
        #calculate torpor depth as % decreased relative to the overall average normohtemric pre value. (.6ish)
        RUN_ID$VO2_Torpor_mean<-mean(RUN_ID$VO2[RUN_ID$State=="TORPOR"], na.rm=T)
        
        RUN_ID$Met_Dep_p<- (1- (RUN_ID$VO2_Torpor_mean/VO2_NORMO_MEAN))*100
        #need to change this to depth not met dep p eventually. 
        
        ########################################################################
        
        #NORMOSPECIFIC variables that will be filled in in the normothery portion of this if statement
        RUN_ID$Normo_Fat_Morn_kJ <- NA 
        RUN_ID$Normo_Fat_Morn_g <- NA
        RUN_ID$Fat_Normo_p_morn<-NA
        
    ############################################################################
    ###########################################################################
    return(RUN_ID)}#END TORPOR BIT
    
    ############################################################################
    ############################################################################
    
    else if(RUN_ID$Torpor_Use[1]=="NORMO"){
        
      #NORMOTHERMIC SPECIFIC CALCULATIONS

        #Integrate fat used in total and before torpor entry #NEED TO CHECK THE ENDS OF EACH NIGHT FOR PROPER INTEGRATION FOR THIS!!
        RUN_ID$Expend_Pre_kJ<-NA #not relevant for normo nights
        RUN_ID$Expend_Entry_kJ<-NA#not relevant for normo nights
        RUN_ID$Expend_Torpor_kJ<-NA#not relevant for normo nights
        RUN_ID$Expend_Arousal_kJ<-NA#not relevant for normo nights
        RUN_ID$Expend_Post_kJ<-NA#not relevant for normo nights
        RUN_ID$Expend_Total_kJ<-auc(RUN_ID$Minute_Elapsed, RUN_ID$VExpend, from=RUN_ID$MinElapsed_LOFF[1], to=last(RUN_ID$Minute_Elapsed), type=c("spline"), subdivisions=3000)
      
        ########################################################################
        #TORPOR variables that are filled in the torpor portion of this if statement
        #calculate fat content (in kJ) by subtracting energy expendiutre before torpor entry from evening fat
        RUN_ID$Entry_Fat_kJ <- NA
        #convert amount of fat (in kJ) remaining at time of torpor entry to g of fat
        RUN_ID$Entry_Fat_g <- NA
        #calculate the threshold!! (assuming body mass in morning was similar to body mass at time of torpor entry)
        RUN_ID$Fat_Entry_p<-NA # the normothemric portion will be filled in below
        #calculate torpor depth as % decreased relative to the overall average normohtemric pre value. (.6ish)
        RUN_ID$VO2_Torpor_mean<-NA
        RUN_ID$Met_Dep_p<-NA#need to change this to depth not met dep p eventually. 
        
        ########################################################################

        #calculate fat content (in kJ) by subtracting energy expendiutre overnight from evening fat
        RUN_ID$Normo_Fat_Morn_kJ <- RUN_ID$Fat_Eve_kJ - RUN_ID$Expend_Total_kJ 
  
        #convert amount of fat (in kJ) remaining at time of torpor entry to g of fat
        RUN_ID$Normo_Fat_Morn_g <- RUN_ID$Normo_Fat_Morn_kJ/37
      
        #calculate the fat content as a % of morning body mass remaining in the morning for normothermic nights
        RUN_ID$Fat_Normo_p_morn<-RUN_ID$Normo_Fat_Morn_g/RUN_ID$Body_Morn_g 
        RUN_ID$Fat_Entry_p<-RUN_ID$Fat_Normo_p_morn*100 #even though its not actually entry, save these normothermic mornign fat contents into the Fat Entry p variable
        
        ##############################################################################################    
        ##############################################################################################

    return(RUN_ID)}  #END NORMOTHERMIC BIT
}#END ENERGTICS FUNCTION

################################################################################
################################################################################

#Copy over rq.state2 to rq.energy to be populated.
rq.energy<-rq.state2

#Set up rq.energy to accept new variables generated in the energetics function
rq.energy$RER_Bound<-NA        
rq.energy$VExpend  <-NA
rq.energy$Fat_Eve_kJ<-NA
rq.energy$Fat_Morn_kJ<-NA
rq.energy$Expend_Min_kJ<-NA
rq.energy$Expend_Min_g<-  NA
rq.energy$Expend_cumsum<-NA
rq.energy$Fat_kJ<-NA
rq.energy$Fat_g <- NA
rq.energy$Fat_p<- NA
rq.energy$Expend_Pre_kJ<-NA
rq.energy$Expend_Entry_kJ  <-NA
rq.energy$Expend_Torpor_kJ<-NA
rq.energy$Expend_Arousal_kJ<-NA
rq.energy$Expend_Post_kJ  <-NA
rq.energy$Expend_Total_kJ  <-NA
rq.energy$Entry_Fat_kJ <-NA
rq.energy$Entry_Fat_g <-NA
rq.energy$Fat_Entry_p<-NA
rq.energy$Fat_Loss_pretorpor_kJ<-NA
rq.energy$VO2_Torpor_mean<-NA
rq.energy$Met_Dep_p  <-NA
rq.energy$Normo_Fat_Morn_kJ <-NA
rq.energy$Normo_Fat_Morn_g <-NA
rq.energy$Fat_Normo_p_morn<-NA


#rq.energy$Expend_Fat_pre_g<-NA

################################################################################
################################################################################

#Run the energy function, populating rq.energy

################################################################################

#DONT run the double torpors cuz they dont work and theyre weird anyway
#DOUBLETORPOR
#rq.energy[rq.energy$Run_ID=="B5_9.2.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B5_9.2.18",])
#DOUBLETORPOR
#rq.energy[rq.energy$Run_ID=="B5_9.8.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B5_9.8.18",])
#DOUBLETORPOR
#rq.energy[rq.energy$Run_ID=="B15_7.2.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B15_7.2.19",])
#DOUBLETORPOR
#rq.energy[rq.energy$Run_ID=="B16_7.7.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B16_7.7.19",])
################################################################################

#Run all nights 

rq.energy[rq.energy$Run_ID=="B2_7.19.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B2_7.19.18",])
rq.energy[rq.energy$Run_ID=="B3_7.19.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B3_7.19.18",])
rq.energy[rq.energy$Run_ID=="B1_7.22.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B1_7.22.18",])
rq.energy[rq.energy$Run_ID=="B2_7.22.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B2_7.22.18",])
rq.energy[rq.energy$Run_ID=="B1_7.26.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B1_7.26.18",])
rq.energy[rq.energy$Run_ID=="B3_7.26.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B3_7.26.18",])
rq.energy[rq.energy$Run_ID=="B2_7.29.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B2_7.29.18",])
rq.energy[rq.energy$Run_ID=="B4_7.29.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B4_7.29.18",])
rq.energy[rq.energy$Run_ID=="B1_7.30.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B1_7.30.18",])
rq.energy[rq.energy$Run_ID=="B3_7.30.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B3_7.30.18",])
rq.energy[rq.energy$Run_ID=="B2_8.6.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B2_8.6.18",])
rq.energy[rq.energy$Run_ID=="B4_8.6.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B4_8.6.18",])
rq.energy[rq.energy$Run_ID=="B1_8.8.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B1_8.8.18",])
rq.energy[rq.energy$Run_ID=="B3_8.8.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B3_8.8.18",])
rq.energy[rq.energy$Run_ID=="B2_8.13.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B2_8.13.18",])
rq.energy[rq.energy$Run_ID=="B4_8.13.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B4_8.13.18",])
rq.energy[rq.energy$Run_ID=="B1_8.15.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B1_8.15.18",])
rq.energy[rq.energy$Run_ID=="B3_8.15.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B3_8.15.18",])
rq.energy[rq.energy$Run_ID=="B2_8.20.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B2_8.20.18",])
rq.energy[rq.energy$Run_ID=="B4_8.20.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B4_8.20.18",])
rq.energy[rq.energy$Run_ID=="B1_8.22.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B1_8.22.18",])
rq.energy[rq.energy$Run_ID=="B5_8.22.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B5_8.22.18",])
rq.energy[rq.energy$Run_ID=="B3_8.24.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B3_8.24.18",])
rq.energy[rq.energy$Run_ID=="B5_8.24.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B5_8.24.18",])
rq.energy[rq.energy$Run_ID=="B2_8.26.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B2_8.26.18",])
rq.energy[rq.energy$Run_ID=="B4_8.26.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B4_8.26.18",])
rq.energy[rq.energy$Run_ID=="B1_8.27.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B1_8.27.18",])
rq.energy[rq.energy$Run_ID=="B5_8.27.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B5_8.27.18",])
rq.energy[rq.energy$Run_ID=="B3_8.29.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B3_8.29.18",])
rq.energy[rq.energy$Run_ID=="B4_8.29.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B4_8.29.18",])
rq.energy[rq.energy$Run_ID=="B1_8.31.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B1_8.31.18",])
rq.energy[rq.energy$Run_ID=="B2_8.31.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B2_8.31.18",])
rq.energy[rq.energy$Run_ID=="B3_9.2.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B3_9.2.18",])
rq.energy[rq.energy$Run_ID=="B4_9.6.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B4_9.6.18",])
rq.energy[rq.energy$Run_ID=="B5_9.6.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B5_9.6.18",])
rq.energy[rq.energy$Run_ID=="B4_9.8.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B4_9.8.18",])
rq.energy[rq.energy$Run_ID=="B1_9.9.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B1_9.9.18",])
rq.energy[rq.energy$Run_ID=="B2_9.9.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B2_9.9.18",])
rq.energy[rq.energy$Run_ID=="B3_9.10.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B3_9.10.18",])
rq.energy[rq.energy$Run_ID=="B5_9.10.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B5_9.10.18",])
rq.energy[rq.energy$Run_ID=="B1_9.12.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B1_9.12.18",])
rq.energy[rq.energy$Run_ID=="B4_9.12.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B4_9.12.18",])
rq.energy[rq.energy$Run_ID=="B2_9.15.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B2_9.15.18",])
rq.energy[rq.energy$Run_ID=="B5_9.15.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B5_9.15.18",])
rq.energy[rq.energy$Run_ID=="B3_9.17.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B3_9.17.18",])
rq.energy[rq.energy$Run_ID=="B5_9.17.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B5_9.17.18",])
rq.energy[rq.energy$Run_ID=="B4_9.19.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B4_9.19.18",])
rq.energy[rq.energy$Run_ID=="B5_9.19.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B5_9.19.18",])
rq.energy[rq.energy$Run_ID=="B1_9.20.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B1_9.20.18",])
rq.energy[rq.energy$Run_ID=="B2_9.20.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B2_9.20.18",])
rq.energy[rq.energy$Run_ID=="B2_9.22.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B2_9.22.18",])
rq.energy[rq.energy$Run_ID=="B3_9.22.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B3_9.22.18",])
rq.energy[rq.energy$Run_ID=="B2_9.23.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B2_9.23.18",])
rq.energy[rq.energy$Run_ID=="B3_9.23.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B3_9.23.18",])
rq.energy[rq.energy$Run_ID=="B4_9.25.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B4_9.25.18",])
rq.energy[rq.energy$Run_ID=="B5_9.25.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B5_9.25.18",])
rq.energy[rq.energy$Run_ID=="B1_9.26.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B1_9.26.18",])
rq.energy[rq.energy$Run_ID=="B4_9.26.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B4_9.26.18",])
rq.energy[rq.energy$Run_ID=="B3_9.27.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B3_9.27.18",])
rq.energy[rq.energy$Run_ID=="B4_9.27.18",]<-calc_energy_func(rq.state2[rq.state2$Run_ID=="B4_9.27.18",])

#2019
rq.energy[rq.energy$Run_ID=="B6_6.24.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B6_6.24.19",])
rq.energy[rq.energy$Run_ID=="B7_6.24.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B7_6.24.19",])
rq.energy[rq.energy$Run_ID=="B8_6.24.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B8_6.24.19",])
#dip
rq.energy[rq.energy$Run_ID=="B9_6.25.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B9_6.25.19",])
rq.energy[rq.energy$Run_ID=="B10_6.25.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B10_6.25.19",])
rq.energy[rq.energy$Run_ID=="B11_6.25.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B11_6.25.19",])
rq.energy[rq.energy$Run_ID=="B6_6.26.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B6_6.26.19",])
rq.energy[rq.energy$Run_ID=="B7_6.26.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B7_6.26.19",])
rq.energy[rq.energy$Run_ID=="B12_6.26.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B12_6.26.19",])
rq.energy[rq.energy$Run_ID=="B8_6.27.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B8_6.27.19",])
rq.energy[rq.energy$Run_ID=="B9_6.27.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B9_6.27.19",])
rq.energy[rq.energy$Run_ID=="B10_6.27.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B10_6.27.19",])
rq.energy[rq.energy$Run_ID=="B11_6.29.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B11_6.29.19",])
rq.energy[rq.energy$Run_ID=="B13_6.29.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B13_6.29.19",])
rq.energy[rq.energy$Run_ID=="B14_6.29.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B14_6.29.19",])
rq.energy[rq.energy$Run_ID=="B6_7.1.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B6_7.1.19",])
#rq.energy[rq.energy$Run_ID=="B7_7.1.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B7_7.1.19",])#
rq.energy[rq.energy$Run_ID=="B8_7.1.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B8_7.1.19",])
rq.energy[rq.energy$Run_ID=="B13_7.2.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B13_7.2.19",])
rq.energy[rq.energy$Run_ID=="B14_7.2.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B14_7.2.19",])
rq.energy[rq.energy$Run_ID=="B9_7.3.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B9_7.3.19",])
rq.energy[rq.energy$Run_ID=="B10_7.3.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B10_7.3.19",])
rq.energy[rq.energy$Run_ID=="B12_7.3.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B12_7.3.19",])
rq.energy[rq.energy$Run_ID=="B6_7.4.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B6_7.4.19",])
rq.energy[rq.energy$Run_ID=="B7_7.4.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B7_7.4.19",])
rq.energy[rq.energy$Run_ID=="B8_7.4.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B8_7.4.19",])
rq.energy[rq.energy$Run_ID=="B12_7.7.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B12_7.7.19",])
rq.energy[rq.energy$Run_ID=="B15_7.7.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B15_7.7.19",])
rq.energy[rq.energy$Run_ID=="B11_7.8.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B11_7.8.19",])
rq.energy[rq.energy$Run_ID=="B13_7.8.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B13_7.8.19",])
rq.energy[rq.energy$Run_ID=="B14_7.8.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B14_7.8.19",])
rq.energy[rq.energy$Run_ID=="B8_7.9.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B8_7.9.19",])
rq.energy[rq.energy$Run_ID=="B9_7.9.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B9_7.9.19",])
rq.energy[rq.energy$Run_ID=="B10_7.9.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B10_7.9.19",])
rq.energy[rq.energy$Run_ID=="B6_7.10.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B6_7.10.19",])
rq.energy[rq.energy$Run_ID=="B7_7.10.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B7_7.10.19",])
rq.energy[rq.energy$Run_ID=="B15_7.10.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B15_7.10.19",])
rq.energy[rq.energy$Run_ID=="B12_7.11.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B12_7.11.19",])
rq.energy[rq.energy$Run_ID=="B13_7.11.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B13_7.11.19",])
rq.energy[rq.energy$Run_ID=="B16_7.11.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B16_7.11.19",])
rq.energy[rq.energy$Run_ID=="B9_7.12.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B9_7.12.19",])
rq.energy[rq.energy$Run_ID=="B14_7.12.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B14_7.12.19",])
rq.energy[rq.energy$Run_ID=="B15_7.12.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B15_7.12.19",])
rq.energy[rq.energy$Run_ID=="B6_7.16.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B6_7.16.19",])
rq.energy[rq.energy$Run_ID=="B7_7.16.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B7_7.16.19",])
rq.energy[rq.energy$Run_ID=="B8_7.16.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B8_7.16.19",])
rq.energy[rq.energy$Run_ID=="B10_7.17.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B10_7.17.19",])
rq.energy[rq.energy$Run_ID=="B11_7.17.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B11_7.17.19",])
rq.energy[rq.energy$Run_ID=="B16_7.17.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B16_7.17.19",])
rq.energy[rq.energy$Run_ID=="B9_7.18.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B9_7.18.19",])
rq.energy[rq.energy$Run_ID=="B13_7.18.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B13_7.18.19",])
rq.energy[rq.energy$Run_ID=="B14_7.18.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B14_7.18.19",])
rq.energy[rq.energy$Run_ID=="B12_7.21.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B12_7.21.19",])
rq.energy[rq.energy$Run_ID=="B15_7.21.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B15_7.21.19",])
rq.energy[rq.energy$Run_ID=="B16_7.21.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B16_7.21.19",])
rq.energy[rq.energy$Run_ID=="B6_7.22.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B6_7.22.19",])
rq.energy[rq.energy$Run_ID=="B7_7.22.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B7_7.22.19",])
rq.energy[rq.energy$Run_ID=="B10_7.23.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B10_7.23.19",])
rq.energy[rq.energy$Run_ID=="B13_7.23.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B13_7.23.19",])
rq.energy[rq.energy$Run_ID=="B16_7.23.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B16_7.23.19",])
rq.energy[rq.energy$Run_ID=="B12_7.25.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B12_7.25.19",])
rq.energy[rq.energy$Run_ID=="B16_7.25.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B16_7.25.19",])
rq.energy[rq.energy$Run_ID=="B17_7.25.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B17_7.25.19",])
rq.energy[rq.energy$Run_ID=="B8_7.29.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B8_7.29.19",])
rq.energy[rq.energy$Run_ID=="B11_7.29.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B11_7.29.19",])
rq.energy[rq.energy$Run_ID=="B14_7.29.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B14_7.29.19",])
rq.energy[rq.energy$Run_ID=="B9_7.30.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B9_7.30.19",])
rq.energy[rq.energy$Run_ID=="B15_7.30.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B15_7.30.19",])
rq.energy[rq.energy$Run_ID=="B17_7.30.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B17_7.30.19",])
rq.energy[rq.energy$Run_ID=="B6_8.9.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B6_8.9.19",])
rq.energy[rq.energy$Run_ID=="B7_8.9.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B7_8.9.19",])
rq.energy[rq.energy$Run_ID=="B10_8.9.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B10_8.9.19",])
rq.energy[rq.energy$Run_ID=="B11_8.10.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B11_8.10.19",])
rq.energy[rq.energy$Run_ID=="B12_8.10.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B12_8.10.19",])
rq.energy[rq.energy$Run_ID=="B17_8.10.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B17_8.10.19",])
rq.energy[rq.energy$Run_ID=="B8_8.11.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B8_8.11.19",])
rq.energy[rq.energy$Run_ID=="B9_8.11.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B9_8.11.19",])
rq.energy[rq.energy$Run_ID=="B13_8.11.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B13_8.11.19",])
rq.energy[rq.energy$Run_ID=="B14_8.12.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B14_8.12.19",])
rq.energy[rq.energy$Run_ID=="B15_8.12.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B15_8.12.19",])
rq.energy[rq.energy$Run_ID=="B16_8.12.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B16_8.12.19",])
rq.energy[rq.energy$Run_ID=="B6_8.13.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B6_8.13.19",])
rq.energy[rq.energy$Run_ID=="B8_8.13.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B8_8.13.19",])
rq.energy[rq.energy$Run_ID=="B17_8.13.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B17_8.13.19",])
rq.energy[rq.energy$Run_ID=="B18_8.14.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B18_8.14.19",])
rq.energy[rq.energy$Run_ID=="B20_8.14.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B20_8.14.19",])
rq.energy[rq.energy$Run_ID=="B22_8.14.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B22_8.14.19",])
rq.energy[rq.energy$Run_ID=="B7_8.20.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B7_8.20.19",])
rq.energy[rq.energy$Run_ID=="B10_8.20.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B10_8.20.19",])
rq.energy[rq.energy$Run_ID=="B11_8.20.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B11_8.20.19",])
rq.energy[rq.energy$Run_ID=="B9_8.21.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B9_8.21.19",])
rq.energy[rq.energy$Run_ID=="B12_8.21.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B12_8.21.19",])
rq.energy[rq.energy$Run_ID=="B14_8.21.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B14_8.21.19",])
rq.energy[rq.energy$Run_ID=="B8_8.23.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B8_8.23.19",])
rq.energy[rq.energy$Run_ID=="B14_8.23.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B14_8.23.19",])
rq.energy[rq.energy$Run_ID=="B15_8.23.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B15_8.23.19",])
rq.energy[rq.energy$Run_ID=="B13_8.24.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B13_8.24.19",])
rq.energy[rq.energy$Run_ID=="B16_8.24.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B16_8.24.19",])
rq.energy[rq.energy$Run_ID=="B17_8.24.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B17_8.24.19",])
rq.energy[rq.energy$Run_ID=="B6_8.26.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B6_8.26.19",])
rq.energy[rq.energy$Run_ID=="B9_8.26.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B9_8.26.19",])
rq.energy[rq.energy$Run_ID=="B12_8.26.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B12_8.26.19",])
rq.energy[rq.energy$Run_ID=="B7_8.31.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B7_8.31.19",])
rq.energy[rq.energy$Run_ID=="B10_8.31.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B10_8.31.19",])
rq.energy[rq.energy$Run_ID=="B14_8.31.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B14_8.31.19",])
rq.energy[rq.energy$Run_ID=="B10_9.1.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B10_9.1.19",])
rq.energy[rq.energy$Run_ID=="B13_9.1.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B13_9.1.19",])
rq.energy[rq.energy$Run_ID=="B14_9.1.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B14_9.1.19",])
rq.energy[rq.energy$Run_ID=="B10_9.2.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B10_9.2.19",])
rq.energy[rq.energy$Run_ID=="B13_9.2.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B13_9.2.19",])
rq.energy[rq.energy$Run_ID=="B15_9.2.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B15_9.2.19",])
rq.energy[rq.energy$Run_ID=="B6_9.3.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B6_9.3.19",])
rq.energy[rq.energy$Run_ID=="B9_9.3.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B9_9.3.19",])
rq.energy[rq.energy$Run_ID=="B16_9.3.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B16_9.3.19",])
rq.energy[rq.energy$Run_ID=="B9_9.4.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B9_9.4.19",])
rq.energy[rq.energy$Run_ID=="B12_9.4.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B12_9.4.19",])
rq.energy[rq.energy$Run_ID=="B14_9.4.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B14_9.4.19",])
rq.energy[rq.energy$Run_ID=="B9_9.5.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B9_9.5.19",])
rq.energy[rq.energy$Run_ID=="B12_9.5.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B12_9.5.19",])
rq.energy[rq.energy$Run_ID=="B14_9.5.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B14_9.5.19",])
rq.energy[rq.energy$Run_ID=="B9_9.6.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B9_9.6.19",])
rq.energy[rq.energy$Run_ID=="B12_9.6.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B12_9.6.19",])
rq.energy[rq.energy$Run_ID=="B14_9.6.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B14_9.6.19",])
rq.energy[rq.energy$Run_ID=="B6_9.7.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B6_9.7.19",])
rq.energy[rq.energy$Run_ID=="B10_9.7.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B10_9.7.19",])
rq.energy[rq.energy$Run_ID=="B15_9.7.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B15_9.7.19",])
rq.energy[rq.energy$Run_ID=="B8_9.9.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B8_9.9.19",])
rq.energy[rq.energy$Run_ID=="B10_9.9.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B10_9.9.19",])
rq.energy[rq.energy$Run_ID=="B15_9.9.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B15_9.9.19",])
rq.energy[rq.energy$Run_ID=="B8_9.10.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B8_9.10.19",])
rq.energy[rq.energy$Run_ID=="B10_9.10.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B10_9.10.19",])
rq.energy[rq.energy$Run_ID=="B15_9.10.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B15_9.10.19",])
rq.energy[rq.energy$Run_ID=="B7_9.11.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B7_9.11.19",])
rq.energy[rq.energy$Run_ID=="B11_9.11.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B11_9.11.19",])
rq.energy[rq.energy$Run_ID=="B11_9.12.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B11_9.12.19",])
rq.energy[rq.energy$Run_ID=="B13_9.12.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B13_9.12.19",])
rq.energy[rq.energy$Run_ID=="B16_9.12.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B16_9.12.19",])
rq.energy[rq.energy$Run_ID=="B11_9.16.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B11_9.16.19",])
rq.energy[rq.energy$Run_ID=="B13_9.16.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B13_9.16.19",])
rq.energy[rq.energy$Run_ID=="B16_9.16.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B16_9.16.19",])
rq.energy[rq.energy$Run_ID=="B11_9.17.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B11_9.17.19",])
rq.energy[rq.energy$Run_ID=="B13_9.17.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B13_9.17.19",])
rq.energy[rq.energy$Run_ID=="B16_9.17.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B16_9.17.19",])
rq.energy[rq.energy$Run_ID=="B6_9.18.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B6_9.18.19",])
rq.energy[rq.energy$Run_ID=="B7_9.18.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B7_9.18.19",])
rq.energy[rq.energy$Run_ID=="B8_9.18.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B8_9.18.19",])
rq.energy[rq.energy$Run_ID=="B8_9.20.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B8_9.20.19",])
rq.energy[rq.energy$Run_ID=="B9_9.20.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B9_9.20.19",])
rq.energy[rq.energy$Run_ID=="B10_9.20.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B10_9.20.19",])
rq.energy[rq.energy$Run_ID=="B9_9.21.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B9_9.21.19",])
rq.energy[rq.energy$Run_ID=="B10_9.21.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B10_9.21.19",])
rq.energy[rq.energy$Run_ID=="B12_9.21.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B12_9.21.19",])
rq.energy[rq.energy$Run_ID=="B12_9.22.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B12_9.22.19",])
rq.energy[rq.energy$Run_ID=="B13_9.22.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B13_9.22.19",])
rq.energy[rq.energy$Run_ID=="B14_9.22.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B14_9.22.19",])
rq.energy[rq.energy$Run_ID=="B13_9.23.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B13_9.23.19",])
rq.energy[rq.energy$Run_ID=="B14_9.23.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B14_9.23.19",])
rq.energy[rq.energy$Run_ID=="B15_9.23.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B15_9.23.19",])
rq.energy[rq.energy$Run_ID=="B11_9.24.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B11_9.24.19",])
rq.energy[rq.energy$Run_ID=="B14_9.24.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B14_9.24.19",])
rq.energy[rq.energy$Run_ID=="B15_9.24.19",]<- calc_energy_func(rq.state2[rq.state2$Run_ID=="B15_9.24.19",])

###########################################################################################################
###########################################################################################################
###########################################################################################################
###########################################################################################################
###########################################################################################################
###########################################################################################################
###########################################################################################################
###########################################################################################################
###########################################################################################################
###########################################################################################################
###########################################################################################################
###########################################################################################################
###########################################################################################################
###########################################################################################################
###########################################################################################################
###########################################################################################################
###########################################################################################################
###########################################################################################################
###########################################################################################################
###########################################################################################################

#Load the date index vector and add it to rq.energy
date.index<-read.csv("date_index.csv")
date.index$Date<- as.Date(date.index$Date,"%m/%d/%Y")
rq.energy$Date_Run<- as.Date(rq.energy$Date_Run)

rq.energy$Date_Index<-NA
fuck<-c(1:136189)
for(i in fuck) {
rq.energy$Date_Index[i]<-date.index$Date_Index[date.index$Date==rq.energy$Date_Run[i]]
  }

rq.energy$Date_Index<-as.numeric(as.character(rq.energy$Date_Index))

########################################################################################################
########################################################################################################
########################################################################################################
########################################################################################################
########################################################################################################
###########################################################################################################
###########################################################################################################
###########################################################################################################
###########################################################################################################
###########################################################################################################
###########################################################################################################
###########################################################################################################
###########################################################################################################
###########################################################################################################
###########################################################################################################
###########################################################################################################
###########################################################################################################
###########################################################################################################
###########################################################################################################
###########################################################################################################

#ADD SEASONAL ANNOTATIONS USING THE PERIOD CUTOFFS DATAFRAME, GENRATED IN THE BODY MASS CODE

########################################################################################################
#SEASONING FUNCTION

#BIRD_ID<-"B1"

seasoning_func<-function(BIRD_ID){

  rq.energy$Catch_Date[rq.energy$Bird_ID==BIRD_ID]<-period.cutoffs$Catch_Date[period.cutoffs$Bird_ID==BIRD_ID]
  rq.energy$Fat_Start[rq.energy$Bird_ID==BIRD_ID]<-period.cutoffs$Fat_Start[period.cutoffs$Bird_ID==BIRD_ID]
  rq.energy$Fat_End[rq.energy$Bird_ID==BIRD_ID]<-period.cutoffs$Fat_End[period.cutoffs$Bird_ID==BIRD_ID]
  rq.energy$Fat_Duration[rq.energy$Bird_ID==BIRD_ID]<-period.cutoffs$Fat_Duration[period.cutoffs$Bird_ID==BIRD_ID]
  
  rq.energy$Body_g_F_Start[rq.energy$Bird_ID==BIRD_ID]<-period.cutoffs$Body_g_F_Start[period.cutoffs$Bird_ID==BIRD_ID]
  rq.energy$Body_g_F_End[rq.energy$Bird_ID==BIRD_ID]<-period.cutoffs$Body_g_F_End[period.cutoffs$Bird_ID==BIRD_ID]
  rq.energy$Body_gi_F[rq.energy$Bird_ID==BIRD_ID]<-period.cutoffs$Body_gi_F[period.cutoffs$Bird_ID==BIRD_ID]
  rq.energy$Body_gpi_F[rq.energy$Bird_ID==BIRD_ID]<-period.cutoffs$Body_gpi_F[period.cutoffs$Bird_ID==BIRD_ID]
  
  rq.energy$Fat_g_F_Start[rq.energy$Bird_ID==BIRD_ID]<-period.cutoffs$Fat_g_F_Start[period.cutoffs$Bird_ID==BIRD_ID]
  rq.energy$Fat_g_F_End[rq.energy$Bird_ID==BIRD_ID]<-period.cutoffs$Fat_g_F_End[period.cutoffs$Bird_ID==BIRD_ID]
  rq.energy$Fat_gi_F[rq.energy$Bird_ID==BIRD_ID]<-period.cutoffs$Fat_gi_F[period.cutoffs$Bird_ID==BIRD_ID]
  rq.energy$Fat_gpi_F[rq.energy$Bird_ID==BIRD_ID]<-period.cutoffs$Fat_gpi_F[period.cutoffs$Bird_ID==BIRD_ID]

  rq.energy$Fat_p_F_Start[rq.energy$Bird_ID==BIRD_ID]<-period.cutoffs$Fat_p_F_Start[period.cutoffs$Bird_ID==BIRD_ID]
  rq.energy$Fat_p_F_End[rq.energy$Bird_ID==BIRD_ID]<-period.cutoffs$Fat_p_F_End[period.cutoffs$Bird_ID==BIRD_ID]
  rq.energy$Fat_pi_F[rq.energy$Bird_ID==BIRD_ID]<-period.cutoffs$Fat_pi_F[period.cutoffs$Bird_ID==BIRD_ID]
  rq.energy$Fat_ppi_F[rq.energy$Bird_ID==BIRD_ID]<-period.cutoffs$Fat_ppi_F[period.cutoffs$Bird_ID==BIRD_ID]
  
#  print(names(rq.energy[rq.energy$Bird_ID==BIRD_ID,]))

return(rq.energy[rq.energy$Bird_ID==BIRD_ID,])
}
#END SEASONING FUNCTION

################################################################################
################################################################################

#Set up rq.seasoned to accept new variables generated in the seasoning function
rq.seasoned<-rq.energy

rq.seasoned$Catch_Date<-NA
rq.seasoned$Fat_Start<-NA
rq.seasoned$Fat_End<-NA
rq.seasoned$Fat_Duration<- NA
rq.seasoned$Body_g_F_Start<-NA
rq.seasoned$Body_g_F_End<-NA
rq.seasoned$Body_gi_F<-NA
rq.seasoned$Body_gpi_F<-NA
rq.seasoned$Fat_g_F_Start<-NA
rq.seasoned$Fat_g_F_End<-NA
rq.seasoned$Fat_gi_F<-NA
rq.seasoned$Fat_gpi_F<-NA
rq.seasoned$Fat_p_F_Start<-NA
rq.seasoned$Fat_p_F_End<-NA
rq.seasoned$Fat_pi_F<-NA
rq.seasoned$Fat_ppi_F<-NA

################################################################################
################################################################################

#Run the SEASONING funciton, populating rq.seasoned

rq.seasoned[rq.seasoned$Bird_ID=="B1",]<- seasoning_func("B1")
rq.seasoned[rq.seasoned$Bird_ID=="B2",]<- seasoning_func("B2")
rq.seasoned[rq.seasoned$Bird_ID=="B3",]<- seasoning_func("B3")
rq.seasoned[rq.seasoned$Bird_ID=="B4",]<- seasoning_func("B4")
rq.seasoned[rq.seasoned$Bird_ID=="B5",]<- seasoning_func("B5")
rq.seasoned[rq.seasoned$Bird_ID=="B6",]<- seasoning_func("B6")
rq.seasoned[rq.seasoned$Bird_ID=="B7",]<- seasoning_func("B7")
rq.seasoned[rq.seasoned$Bird_ID=="B8",]<- seasoning_func("B8")
rq.seasoned[rq.seasoned$Bird_ID=="B9",]<- seasoning_func("B9")
rq.seasoned[rq.seasoned$Bird_ID=="B10",]<- seasoning_func("B10")
rq.seasoned[rq.seasoned$Bird_ID=="B11",]<- seasoning_func("B11")
rq.seasoned[rq.seasoned$Bird_ID=="B12",]<- seasoning_func("B12")
rq.seasoned[rq.seasoned$Bird_ID=="B13",]<- seasoning_func("B13")
rq.seasoned[rq.seasoned$Bird_ID=="B14",]<- seasoning_func("B14")
rq.seasoned[rq.seasoned$Bird_ID=="B15",]<- seasoning_func("B15")
rq.seasoned[rq.seasoned$Bird_ID=="B16",]<- seasoning_func("B16")
#rq.seasoned[rq.seasoned$Bird_ID=="B17",]<- seasoning_func("B17")
# rq.seasoned[rq.seasoned$Bird_ID=="B18",]<- seasoning_func("B18")
# rq.seasoned[rq.seasoned$Bird_ID=="B19",]<- seasoning_func("B19")
# rq.seasoned[rq.seasoned$Bird_ID=="B26",]<- seasoning_func("B26")

################################################################################
################################################################################

#FILL IN SEASONS, BASED ON SEASONAL CUTOFFS, BASED ON CHANGES IN BODY MASS
rq.seasoned$Season<-NA

#where date index is less than fat start date, label it "Summer"
rq.seasoned$Season[rq.seasoned$Date_Index < rq.seasoned$Fat_Start]<- "Summer" 

#where date index is more than or equal to fat start date AND less than fat end date, label it "Fattening"
rq.seasoned$Season[rq.seasoned$Date_Index >= rq.seasoned$Fat_Start &rq.seasoned$Date_Index < rq.seasoned$Fat_End]<- "Fattening"

#where date index is more than or equal to fat end date, label it "Fattening"
rq.seasoned$Season[rq.seasoned$Date_Index >= rq.seasoned$Fat_End]<- "Migration"

#label nonfatteners 
rq.seasoned$Season[rq.seasoned$Bird_ID %in% c("B2","B5", "B8")]<- "Non-Fattener"

################################################################################
################################################################################

#LABEL OVERALL TYPE OF BODY MASS CHANGE FOR EACH BIRD

rq.seasoned$Pattern[rq.seasoned$Bird_ID=="B1"]<- "Fattener"
rq.seasoned$Pattern[rq.seasoned$Bird_ID=="B2"]<- "NonFattener"
rq.seasoned$Pattern[rq.seasoned$Bird_ID=="B3"]<- "Fattener"
rq.seasoned$Pattern[rq.seasoned$Bird_ID=="B4"]<- "Fattener"
rq.seasoned$Pattern[rq.seasoned$Bird_ID=="B5"]<- "NonFattener"
rq.seasoned$Pattern[rq.seasoned$Bird_ID=="B6"]<- "Fattener"
rq.seasoned$Pattern[rq.seasoned$Bird_ID=="B7"]<- "Fattener"
rq.seasoned$Pattern[rq.seasoned$Bird_ID=="B8"]<- "NonFattener"
rq.seasoned$Pattern[rq.seasoned$Bird_ID=="B9"]<- "Fattener"
rq.seasoned$Pattern[rq.seasoned$Bird_ID=="B10"]<- "Fattener"
rq.seasoned$Pattern[rq.seasoned$Bird_ID=="B11"]<- "Fattener"
rq.seasoned$Pattern[rq.seasoned$Bird_ID=="B12"]<- "Fattener"
rq.seasoned$Pattern[rq.seasoned$Bird_ID=="B13"]<- "Fattener"
rq.seasoned$Pattern[rq.seasoned$Bird_ID=="B14"]<- "Fattener"
rq.seasoned$Pattern[rq.seasoned$Bird_ID=="B15"]<- "Fattener"
rq.seasoned$Pattern[rq.seasoned$Bird_ID=="B16"]<- "Fattener"

################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################

#copy rq.seasoned over to the final dataframe and save it
rq.final<-rq.seasoned

#SAVE A FINAL DATASET.
setwd("~/ERICH_EBERTS/ACADEMICS/PROJECTS/FAT/FAT_DATA/FAT_CODE/FINAL_DATA")
write.csv(rq.final, "rq_final.csv", row.names = F) 

################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
################################################################################
#PLOT AN EXAMPLE OF ONE NIGHT OF HOW I CATAGORIZED TORPOR

RUN_ID<-rq.state2[rq.state2$Run_ID=="B13_9.2.19",]
#ENTRY_CUTOFF<-#
##AROUSAL_CUTOFF<-#
  
 #GENERATE A PLOT OF VO2 WITH RAW, SMOOTHED, AND DERIVITIVE DATA TO CHECK AND TO REPRESENT HOW STATE ANNOTATIONS WORKED

  plot<-ggplot(data=RUN_ID)+
    
    geom_point(aes(x=Minute_Elapsed, y=VO2_smootha,col=State2),lwd=6,alpha=.4)+
    geom_point(aes(x=Minute_Elapsed, y=VO2_smoothb,col=State2),lwd=6,alpha=.4)+

    scale_color_manual(values=c("FREAKOUT"="green","NORMOPRE"="red","ENTRY"="purple","TORPOR"="blue","AROUSAL"="orange","NORMOPOST"="red"))+

    geom_point(aes(x=Minute_Elapsed, y=VO2), col="black",lwd=3)+
    geom_line(aes(x=Minute_Elapsed, y=VO2_int), col="black",lwd=.5)+
    
    geom_line(aes(x=Minute_Elapsed, y=abs(VO2_smootha_deriv*20),col=State2), lwd=.5)+
    geom_line(aes(x=Minute_Elapsed, y=abs(VO2_smoothb_deriv*20),col=State2),lwd=.5)+
  
    scale_y_continuous(name="VO2 (ml/min)",breaks = seq(0, 5, by = .1), sec.axis = sec_axis(trans=~./20, name="Slope Of Smoothed VO2 (abs val)", breaks = seq(0, .1, by = .05)))+
    scale_x_continuous(name="Time, Minutes Elapsed")+
  
    geom_hline(yintercept=-ENTRY_CUTOFF*20, col="blue", lwd=1, linetype=1)+
    geom_hline(yintercept=AROUSAL_CUTOFF*20, col="red", lwd=1, linetype=3)+

    my_theme  +
      theme(axis.text.x = element_text(angle=0, size=16), legend.key.height = unit(3, 'lines'),
        panel.grid.major.y = element_line(color='white'),
        panel.grid.minor.y = element_line(color='white'))+
      theme(axis.text.y = element_text(angle=0, size=20), legend.key.height = unit(3, 'lines'),
        panel.grid.major.x = element_line(color='white'), 
        panel.grid.minor.x = element_line(color='white'))
      
  print(plot)
################################################################################
  
  

#GENERATE THE SECOND STATE FUNCTION WHICH ASSIGNS REAL STATES BASED ON 2 SEPARATE SPLINES. 

#run this code in the local environment in order to produce an example plot for Fig. S3

RUN_ID<-rq.state[rq.state$Run_ID=="B13_9.2.19",]
SPARA<-.6
SPARB<-.5

#TORPOR_smooth2_state_func<-function(RUN_ID, SPARA,SPARB, ENTRY_CUTOFF,AROUSAL_CUTOFF){
    ############################################################################

    #FIRST GENERATE VECTORS OF INTERPOLATED, SMOOTHED VO2 DATA AND ITS SLOPE
    #FOR 2 SEPARATE SPLINES- A IS FOR ENTRY, B IS FOR AROUSAL.
  
    ############################################################################
  
    #interpolate data linearly
    RUN_ID$VO2_int2<-na.approx(RUN_ID$VO2, x=RUN_ID$Minute_Elapsed, na.rm=F)#,rule=2)
    #plot(RUN_ID$VO2_int)

    ############################################################################

    #ENTRY SMOOTH
    #generate a spline model to smooth interpolated data
    splinemod.a.vo2<-smooth.spline(RUN_ID$VO2_int2[is.na(RUN_ID$VO2_int2)==F&RUN_ID$Minute_Elapsed<RUN_ID$Torpor_End],
                          x=RUN_ID$Minute_Elapsed[is.na(RUN_ID$VO2_int)==F&RUN_ID$Minute_Elapsed<RUN_ID$Torpor_End],
                            spar=SPARA) 
    
    #generate smoothed VO2 data for each minute, based on above spline model
    predmodela<- predict(splinemod.a.vo2, x=seq(0,RUN_ID$Torpor_End[1], length=RUN_ID$Torpor_End[1])) 
    RUN_ID$VO2_smootha<-NA
    RUN_ID$VO2_smootha[0:RUN_ID$Torpor_End[1]] <-predmodela$y[0:RUN_ID$Torpor_End[1]] 
    #plot(predmodela)
    
    #generate the first derivative (slope) of smoothed VO2 data for each minute, based on above spline model
    predmodela_deriv<- predict(splinemod.a.vo2,deriv=1, x=seq(0,RUN_ID$Torpor_End[1], length=RUN_ID$Torpor_End[1])) 
    RUN_ID$VO2_smootha_deriv<-NA
    RUN_ID$VO2_smootha_deriv[0:RUN_ID$Torpor_End[1]] <-predmodela_deriv$y[0:RUN_ID$Torpor_End[1]] 
    #plot(predmodela_deriv)

    ############################################################################
    
    #AROUSAL SMOOTH
    #generate a spline model to smooth interpolated data
    splinemod.b.vo2<-smooth.spline(RUN_ID$VO2_int[is.na(RUN_ID$VO2_int)==F&RUN_ID$Minute_Elapsed>=RUN_ID$Torpor_End],
                          x=RUN_ID$Minute_Elapsed[is.na(RUN_ID$VO2_int)==F&RUN_ID$Minute_Elapsed>=RUN_ID$Torpor_End],
                            spar=SPARB)
    
    #generate smoothed VO2 data for each minute, based on above spline model
    predmodelb<- predict(splinemod.b.vo2, x=seq(RUN_ID$Torpor_End[1],length(RUN_ID$Minute_Elapsed), length=length(RUN_ID$Minute_Elapsed)-RUN_ID$Torpor_End[1])) 
    RUN_ID$VO2_smoothb<-NA
    RUN_ID$VO2_smoothb[RUN_ID$Minute_Elapsed>=RUN_ID$Torpor_End[1]&RUN_ID$Minute_Elapsed<=length(RUN_ID$Minute_Elapsed)] <-predmodelb$y[predmodelb$x>=RUN_ID$Torpor_End[1] &predmodelb$x<=length(RUN_ID$Minute_Elapsed)] 
    #plot(predmodelb)

    #generate the first derivative (slope) of smoothed VO2 data for each minute, based on above spline model
    predmodelb_deriv<- predict(splinemod.b.vo2, deriv=1, x=seq(RUN_ID$Torpor_End[1],length(RUN_ID$Minute_Elapsed), length=length(RUN_ID$Minute_Elapsed)-RUN_ID$Torpor_End[1])) 
    RUN_ID$VO2_smoothb_deriv<-NA
    RUN_ID$VO2_smoothb_deriv[RUN_ID$Minute_Elapsed>=RUN_ID$Torpor_End[1]&RUN_ID$Minute_Elapsed<=length(RUN_ID$Minute_Elapsed)] <-predmodelb_deriv$y[predmodelb$x>=RUN_ID$Torpor_End[1] &predmodelb_deriv$x<=length(RUN_ID$Minute_Elapsed)] 
    #plot(predmodelb_deriv)

    ############################################################################

    ##Generate a plot to check the smoothed and derivitive data for both splines
    #ggplot(data=RUN_ID)+
    # geom_point(aes(x=Minute_Elapsed,y=VO2_smootha), col="blue", lwd=3, alpha=.6)+
    # geom_point(aes(x=Minute_Elapsed,y=VO2_smootha_deriv), col="blue", lwd=3, alpha=.6)+
    # geom_point(aes(x=Minute_Elapsed,y=VO2_smoothb), col="red", lwd=3, alpha=.6)+
    # geom_point(aes(x=Minute_Elapsed,y=VO2_smoothb_deriv), col="red", lwd=3, alpha=.6)+
    # geom_point(aes(x=Minute_Elapsed,y=VO2), col="black")+
    #my_theme
 
    ################################################################################    
    ################################################################################
    ################################################################################    
    ################################################################################
    ################################################################################    
      
    #CALCULATE ENTRY AND AROUSAL CUTOFF VALUES
    
    ############################################################################
    
    #ENTRY CUTOFF
    #calculate the mean slope of the smoothed VO2 during the normothermic pre period (spline a)
    VO2_normopre_deriv_mean<-mean(RUN_ID$VO2_smootha_deriv[RUN_ID$State=="NORMOPRE"],na.rm=T)
    VO2_normopre_deriv_sd<-sd(RUN_ID$VO2_smootha_deriv[RUN_ID$State=="NORMOPRE"],na.rm=T)
    
    #calculate the entry cut off as the mean slope of the normothermic period plus 2 standard deviations
    ENTRY_CUTOFF<- -1*(VO2_normopre_deriv_mean+VO2_normopre_deriv_sd*2)
    RUN_ID$Entry_Cutoff<-ENTRY_CUTOFF
    
    #in the cases (10ish) where there is minimal or no normothermic pre period, 
    #use the average entry cutoff for the other birds, which i manually calculated
    #outside this function, excluding the problematic nights.
    if(RUN_ID$NormoPre_Prob[1]=="NoPre"){
        RUN_ID$Entry_Cutoff<- -0.0022
        ENTRY_CUTOFF<- -0.0022}
    
    ############################################################################
    
    #AROUSAL CUTOFF
    #calculate the mean slope of the smoothed VO2 during the torpid period (spline a)
    VO2_torpor_deriv_mean<-mean(RUN_ID$VO2_smootha_deriv[RUN_ID$State=="TORPOR"],na.rm=T)
    VO2_torpor_deriv_sd<-sd(RUN_ID$VO2_smootha_deriv[RUN_ID$State=="TORPOR"],na.rm=T)
    
    #calculate the arousal cut off as the mean slope of the torpid period plus 5 standard deviations
    AROUSAL_CUTOFF<-(VO2_torpor_deriv_mean+VO2_torpor_deriv_sd*5)
    RUN_ID$Arousal_Cutoff<-AROUSAL_CUTOFF
    
    ############################################################################
    ############################################################################
    ############################################################################
    ############################################################################
    ############################################################################
    
    #ANNOTATE EACH MINUTE OF VO2 WITH A STABILITY LABEL BASED ON ITS RATE OF CHANGE
    #AND THE CUTOFF VALUES

    RUN_ID$Stability2<-"STABLE" #make everything stable to start
    
    #label everything with a slope of less than than the cutoff as "DECREASING"
    RUN_ID$Stability2[RUN_ID$VO2_smootha_deriv < ENTRY_CUTOFF] <- "DECREASING"#ENTRY_CUTOFF
    
    #label everything with a slope of greater than than the cutoff as "INCREASING"
    RUN_ID$Stability2[RUN_ID$VO2_smoothb_deriv > AROUSAL_CUTOFF] <-"INCREASING"

    #copy the stability labels to STATE
    RUN_ID$State2<-RUN_ID$Stability2
    
    #generate a plot to check that the stability is working right
    #ggplot(data=RUN_ID)+
    #  geom_point(aes(x=Minute_Elapsed, y=VO2), col="black",lwd=2)+
    #  geom_point(aes(x=Minute_Elapsed, y=VO2_smootha_deriv, col=Stability2))+
    #  geom_point(aes(x=Minute_Elapsed, y=VO2_smootha, col=Stability2),lwd=2 ,alpha=.9)+
    #  geom_point(aes(x=Minute_Elapsed, y=VO2_smoothb_deriv, col=Stability2))+
    #  geom_point(aes(x=Minute_Elapsed, y=VO2_smoothb, col=Stability2),lwd=2 ,alpha=.9)+
    #  geom_line(aes(x=Minute_Elapsed, y=VO2_int), col="black")+
    #  geom_hline(yintercept = 0, col="black")+
    #  scale_color_brewer(palette="Set1")+
    #  my_theme  #+ theme(legend.position = "none")
    
    ############################################################################
    ############################################################################
    ############################################################################
    ############################################################################
    ############################################################################
    
    #ANNOTATE EACH MINUTE OF VO2 WITH A STATE LABEL BASED ON THE STABILITY AND THE LOGICAL ORDER OF TORPOR
    
    ############################################################################
   #####################################################
    
    #FULL TORPOR 
    if(RUN_ID$Torpor_Type[1]=="Full"){

        #where vo2 INCREASING and min elapsed is AFTER the 1st stable period, label as AROUSAL
        RUN_ID$State2[RUN_ID$Stability2=="INCREASING" &
                      RUN_ID$Minute_Elapsed >= first(RUN_ID$Minute_Elapsed[RUN_ID$Stability2=="STABLE"])]<-"AROUSAL"
          
        #where VO2 STABLE, and min elapsed is before the start of entry, as "NORMOPRE"
        RUN_ID$State2[RUN_ID$Stability2== "STABLE" & 
                      RUN_ID$Minute_Elapsed <= last(RUN_ID$Minute_Elapsed[RUN_ID$Stability2=="DECREASING"])] <- "NORMOPRE" 
          
        #where VO2 stable, and min elapsed is after the start of AROUSAL, as "NORMOPOST"
        RUN_ID$State2[RUN_ID$Stability2== "STABLE" &
                       RUN_ID$Minute_Elapsed >= last(RUN_ID$Minute_Elapsed[RUN_ID$Stability2=="INCREASING"])] <- "NORMOPOST" 
         
        #where VO2 is DECREASING, and min elapsed is BEFORE THE START OF NORMOPRE , as "FREAKOUT"
        RUN_ID$State2[RUN_ID$State2== "DECREASING" & 
                      RUN_ID$Minute_Elapsed <= first(RUN_ID$Minute_Elapsed[RUN_ID$State2=="NORMOPRE"])] <- "FREAKOUT" 
          
        #where VO2 is DECREASING, and min elapsed is AFTER the start of entry, as "ENTRY"
        RUN_ID$State2[RUN_ID$State2== "DECREASING" & 
                       RUN_ID$Minute_Elapsed >= last(RUN_ID$Minute_Elapsed[RUN_ID$State2=="NORMOPRE"])] <- "ENTRY" 
          
        #where VO2 stable, and min elapsed is AFTER the end of entry, and BEFORE the start of arousal, as TORPOR
        RUN_ID$State2[RUN_ID$Minute_Elapsed <= (first(RUN_ID$Minute_Elapsed[RUN_ID$State2=="AROUSAL"])) &
                       RUN_ID$Minute_Elapsed >= (last(RUN_ID$Minute_Elapsed[RUN_ID$State2=="ENTRY"]))] <- "TORPOR" 
        (RUN_ID$State2)

      }#END FULL TORPOR

    #RESTRUCTURE STATE AS A FACTOR
    #well this turns some pieces into NA, and messes stuff up as a factor, so i just turn it back to a character. 

    RUN_ID$State2<-factor(RUN_ID$State2, levels=c("FREAKOUT","NORMOPRE","ENTRY","TORPOR","AROUSAL", "NORMOPOST"),ordered=F)
    RUN_ID$State2<-as.character(RUN_ID$State2)
    
    #END STATE ANNOTATIONS 
    #################################################################################     
    #################################################################################     
    #################################################################################     
    #################################################################################     
    #################################################################################     

    #CALCULATE SEVERAL SPECIFIC VALUES FOR EACH NIGHT AND SAVE THEM TO RUN_ID
  
    #################################################################################     

    #Create vectors of single values for the boundaries of each state period
    RUN_ID$Freak_Start<-min(RUN_ID$Minute_Elapsed[RUN_ID$State2=="FREAKOUT"],na.rm=T)
    RUN_ID$Freak_End<-max(RUN_ID$Minute_Elapsed[RUN_ID$State2=="FREAKOUT"],na.rm=T)
    RUN_ID$Normopre_Start<-min(RUN_ID$Minute_Elapsed[RUN_ID$State2=="NORMOPRE"],na.rm=T)
    RUN_ID$Normopre_End<-max(RUN_ID$Minute_Elapsed[RUN_ID$State2=="NORMOPRE"],na.rm=T)
    RUN_ID$Entry_Start<-min(RUN_ID$Minute_Elapsed[RUN_ID$State2=="ENTRY"],na.rm=T)
    RUN_ID$Entry_End<-max(RUN_ID$Minute_Elapsed[RUN_ID$State2=="ENTRY"],na.rm=T)
    RUN_ID$Torpor_Start<-min(RUN_ID$Minute_Elapsed[RUN_ID$State2=="TORPOR"],na.rm=T)
    RUN_ID$Torpor_End<-max(RUN_ID$Minute_Elapsed[RUN_ID$State2=="TORPOR"],na.rm=T)
    RUN_ID$Arousal_Start<-min(RUN_ID$Minute_Elapsed[RUN_ID$State2=="AROUSAL"],na.rm=T)
    RUN_ID$Arousal_End<-max(RUN_ID$Minute_Elapsed[RUN_ID$State2=="AROUSAL"],na.rm=T)
    RUN_ID$Normopost_Start<-min(RUN_ID$Minute_Elapsed[RUN_ID$State2=="NORMOPOST"],na.rm=T)
    RUN_ID$Normopost_End<-max(RUN_ID$Minute_Elapsed[RUN_ID$State2=="NORMOPOST"],na.rm=T)
    
    ###########################################################################3
    
    #Calculate the absolute amount of time (currenlty in minutes) in each state
    RUN_ID$Pre_Duration<-RUN_ID$Normopre_End-RUN_ID$MinElapsed_LOFF
    RUN_ID$Entry_Duration<-RUN_ID$Entry_End-RUN_ID$Entry_Start
    RUN_ID$Torpor_Duration<-RUN_ID$Torpor_End-RUN_ID$Torpor_Start
    RUN_ID$Arousal_Duration<-RUN_ID$Arousal_End-RUN_ID$Arousal_Start #this is currently garbage b.c. the state function doesnt do well with the arousal
    RUN_ID$Post_Duration<-RUN_ID$Normopost_End-RUN_ID$Normopost_Start
    RUN_ID$Night_Duration<-RUN_ID$MinElapsed_LON
    
    ###########################################################################
    
    #Calculate a time vector relative to each nights duraiton
    RUN_ID$Time_p<- (RUN_ID$Minute_Elapsed/RUN_ID$Night_Duration)*100
    
    ###########################################################################
    
    #Calculate the time amount of time in p that the bird transitioned to and from each key state
    #RUN_ID$Time_p_LOFF<-RUN_ID$Minute_Elapsed[RUN_ID$Minute_Elapsed==RUN_ID$MinElapsed_LOFF[1]]/RUN_ID$Night_Duration#SHOUDL BE 0%
    RUN_ID$Time_p_Entry_Start<-RUN_ID$Minute_Elapsed[RUN_ID$Minute_Elapsed==RUN_ID$Entry_Start[1]]/RUN_ID$Night_Duration*100
    RUN_ID$Time_p_Entry_End<-RUN_ID$Minute_Elapsed[RUN_ID$Minute_Elapsed==RUN_ID$Entry_End[1]]/RUN_ID$Night_Duration*100
    RUN_ID$Time_p_Torpor_Start<-RUN_ID$Minute_Elapsed[RUN_ID$Minute_Elapsed==RUN_ID$Torpor_Start[1]]/RUN_ID$Night_Duration*100
    RUN_ID$Time_p_Torpor_End<-RUN_ID$Minute_Elapsed[RUN_ID$Minute_Elapsed==RUN_ID$Torpor_End[1]]/RUN_ID$Night_Duration*100
    RUN_ID$Time_p_Arousal_Start<-RUN_ID$Minute_Elapsed[RUN_ID$Minute_Elapsed==RUN_ID$Arousal_Start[1]]/RUN_ID$Night_Duration*100
    RUN_ID$Time_p_Arousal_End<-RUN_ID$Minute_Elapsed[RUN_ID$Minute_Elapsed==RUN_ID$Arousal_End[1]]/RUN_ID$Night_Duration*100
    #RUN_ID$Time_p_LON<-RUN_ID$Minute_Elapsed[RUN_ID$Minute_Elapsed==RUN_ID$MinElapsed_LON[1]]/RUN_ID$Night_Duration#SHOUDL BE 0%
    
    ###########################################################################
    
    #calculate % of the night spent in each State2 #probably a redundant variable name, i dont think i ever use this should just rename with units
    RUN_ID$Pre_Percent_Night<- RUN_ID$Pre_Duration/ RUN_ID$Night_Duration
    RUN_ID$Entry_Percent_Night<-RUN_ID$Entry_Duration/ RUN_ID$Night_Duration
    RUN_ID$Torpor_Percent_Night<-RUN_ID$Torpor_Duration/ RUN_ID$Night_Duration
    RUN_ID$Arousal_Percent_Night<-RUN_ID$Arousal_Duration/ RUN_ID$Night_Duration
    RUN_ID$Post_Percent_Night<-RUN_ID$Post_Duration/ RUN_ID$Night_Duration
    #if i decide i dont want these numbers
    # RUN_ID$Pre_Percent_Night<- NA
    # RUN_ID$Entry_Percent_Night<-NA
    # RUN_ID$Torpor_Percent_Night<-NA
    # RUN_ID$Arousal_Percent_Night<-NA
    # RUN_ID$Post_Percent_Night<-NA
    
  ###############################################################################    
  ###############################################################################    
  ###############################################################################    
 #Set the theme for any ggplot figures

my_theme <- theme_classic(base_size = 14) + 
  theme(panel.border = element_rect(colour = "black", fill=NA)) +
  theme(axis.text.x = element_text(angle=0, size=16), legend.key.height = unit(3, 'lines'),
        panel.grid.major.y = element_line(color='white'),
        panel.grid.minor.y = element_line(color='white'))+
  theme(axis.text.y = element_text(angle=0, size=16), legend.key.height = unit(3, 'lines'),
        panel.grid.major.x = element_line(color='white'))+
  theme(plot.caption = element_text(size = 10, hjust = 0.5))+
  theme(axis.title.x = element_text(vjust=-3, size=20))+
  theme(axis.title.y = element_text(vjust= 4,size=20))+
  theme(plot.margin = margin(1, 1, 1, 1, "cm"))+
  
  theme(legend.position = "none") +
  #theme(legend.title=element_blank())+
  
  #for facet plot labels
  # theme(strip.text.x = element_text(size=8, color="black",
  #                                     face="plain", hjust=0))+
  #         
  # theme(strip.background = element_rect(colour="black", fill="white", 
  #                                      size=.5, linetype="solid"))

  theme(strip.background = element_blank(), strip.text.x = element_blank())
  ###############################################################################    
  ###############################################################################    

  #GENERATE A PLOT OF VO2 WITH RAW, SMOOTHED, AND DERIVITIVE DATA TO CHECK AND TO REPRESENT HOW STATE ANNOTATIONS WORKED

  plot<-ggplot(data=RUN_ID)+
    
    geom_point(aes(x=Minute_Elapsed, y=VO2_smootha,col=State2),lwd=4,alpha=.06)+
    geom_point(aes(x=Minute_Elapsed, y=VO2_smoothb,col=State2),lwd=4,alpha=.06)+

    scale_color_manual(values=c("FREAKOUT"="green","NORMOPRE"="red","ENTRY"="purple","TORPOR"="blue","AROUSAL"="orange","NORMOPOST"="red"))+

    geom_point(aes(x=Minute_Elapsed, y=VO2), col="black",lwd=2)+
    geom_line(aes(x=Minute_Elapsed, y=VO2_int), col="black",lwd=.5)+
    
    geom_line(aes(x=Minute_Elapsed, y=abs(VO2_smootha_deriv*20),col=State2), lwd=.5)+
    geom_line(aes(x=Minute_Elapsed, y=abs(VO2_smoothb_deriv*20),col=State2),lwd=.5)+
  
    scale_y_continuous(name="Metabolic Rate\n(VO2, mlO2/min)",breaks = seq(0, 5, by = .2), sec.axis = sec_axis(trans=~./20, name="Absolute Value of\nSlope Of Smoothed MR", breaks = seq(0, .1, by = .01)))+
    scale_x_continuous(name="Time, Minutes Elapsed")+
  
    geom_hline(yintercept=-ENTRY_CUTOFF*20, col="blue", lwd=1, linetype=1)+
    geom_hline(yintercept=AROUSAL_CUTOFF*20, col="red", lwd=1, linetype=3)+

    my_theme  +
      theme(axis.text.x = element_text(angle=0, size=16), legend.key.height = unit(3, 'lines'),
        panel.grid.major.y = element_line(color='white'),
        panel.grid.minor.y = element_line(color='white'))+
      theme(axis.text.y = element_text(angle=0, size=20), legend.key.height = unit(3, 'lines'),
        panel.grid.major.x = element_line(color='white'), 
        panel.grid.minor.x = element_line(color='white'))+
        theme(axis.title.y.right = element_text(vjust= 4,size=20))
      
  print(plot)
supfig8<-plot
  
  
#RESET WD TO SAVE FIGURES TO A SPECIFIC FOLDER.

setwd("~/ERICH_EBERTS/ACADEMICS/PROJECTS/FAT/FAT_WRITING/Figures")

ggexport(supfig8, filename = "Sup Fig 8. Example VO2 Trace.tiff",width = 650,height = 400)


################################################################################
################################################################################
################################################################################
#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#
#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#
#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#
#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#
#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#
#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#
#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#
#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#
#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#
#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#
#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#
#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#
#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#THE END#